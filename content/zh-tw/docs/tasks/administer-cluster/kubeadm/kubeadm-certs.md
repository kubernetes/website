---
title: 使用 kubeadm 進行證書管理
content_type: task
weight: 80
---
<!--
reviewers:
- sig-cluster-lifecycle
title: Certificate Management with kubeadm
content_type: task
weight: 80
-->

<!-- overview -->

{{< feature-state for_k8s_version="v1.15" state="stable" >}}

<!--
Client certificates generated by [kubeadm](/docs/reference/setup-tools/kubeadm/) expire after 1 year.
This page explains how to manage certificate renewals with kubeadm. It also covers other tasks related
to kubeadm certificate management.
-->
由 [kubeadm](/zh-cn/docs/reference/setup-tools/kubeadm/) 生成的客戶端證書在 1 年後到期。
本頁說明如何使用 kubeadm 管理證書續訂，同時也涵蓋其他與 kubeadm 證書管理相關的說明。

<!--
The Kubernetes project recommends upgrading to the latest patch releases promptly, and
to ensure that you are running a supported minor release of Kubernetes.
Following this recommendation helps you to stay secure.
-->
Kubernetes 項目建議及時升級到最新的補丁版本，並確保你正在運行受支持的 Kubernetes 次要版本。
遵循這一建議有助於你確保安全。

## {{% heading "prerequisites" %}}

<!--
You should be familiar with [PKI certificates and requirements in Kubernetes](/docs/setup/best-practices/certificates/).

You should be familiar with how to pass a [configuration](/docs/reference/config-api/kubeadm-config.v1beta4/) file to the kubeadm commands.
-->
你應該熟悉 [Kubernetes 中的 PKI 證書和要求](/zh-cn/docs/setup/best-practices/certificates/)。

你應該熟悉如何將一個[設定](/zh-cn/docs/reference/config-api/kubeadm-config.v1beta4/)檔案傳遞給
kubeadm 命令。

<!--
This guide covers the usage of the `openssl` command (used for manual certificate signing,
if you choose that approach), but you can use your preferred tools.

Some of the steps here use `sudo` for administrator access. You can use any equivalent tool.
-->
本指南將介紹如何使用 `openssl` 命令（用於手動證書籤名），但你可以使用你喜歡的工具。

這裏的一些步驟使用 `sudo` 來獲取管理員訪問權限。你可以使用任何等效的工具。

<!-- steps -->

<!--
## Using custom certificates {#custom-certificates}

By default, kubeadm generates all the certificates needed for a cluster to run.
You can override this behavior by providing your own certificates.
-->
## 使用自定義的證書   {#custom-certificates}

預設情況下，kubeadm 會生成運行一個叢集所需的全部證書。
你可以通過提供你自己的證書來改變這個行爲策略。

<!--
To do so, you must place them in whatever directory is specified by the
`--cert-dir` flag or the `certificatesDir` field of kubeadm's `ClusterConfiguration`.
By default this is `/etc/kubernetes/pki`.
-->
如果要這樣做，你必須將證書檔案放置在通過 `--cert-dir` 命令列參數或者 kubeadm 設定中的
`certificatesDir` 設定項指明的目錄中。預設的值是 `/etc/kubernetes/pki`。

<!--
If a given certificate and private key pair exists before running `kubeadm init`,
kubeadm does not overwrite them. This means you can, for example, copy an existing
CA into `/etc/kubernetes/pki/ca.crt` and `/etc/kubernetes/pki/ca.key`,
and kubeadm will use this CA for signing the rest of the certificates.
-->
如果在運行 `kubeadm init` 之前存在給定的證書和私鑰對，kubeadm 將不會重寫它們。
例如，這意味着你可以將現有的 CA 複製到 `/etc/kubernetes/pki/ca.crt` 和
`/etc/kubernetes/pki/ca.key` 中，而 kubeadm 將使用此 CA 對其餘證書進行簽名。

<!--
## Choosing an encryption algorithm {#choosing-encryption-algorithm}

kubeadm allows you to choose an encryption algorithm that is used for creating
public and private keys. That can be done by using the `encryptionAlgorithm` field of the
kubeadm configuration:
-->
## 選擇加密算法    {#choosing-encryption-algorithm}

kubeadm 允許你選擇用於創建公鑰和私鑰的加密算法。這可以通過使用
kubeadm 設定中的 `encryptionAlgorithm` 字段來實現。

```yaml
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
encryptionAlgorithm: <ALGORITHM>
```

<!--
`<ALGORITHM>` can be one of `RSA-2048` (default), `RSA-3072`, `RSA-4096` or `ECDSA-P256`.
-->
`<ALGORITHM>` 可以是 `RSA-2048`（預設）、`RSA-3072`、`RSA-4096`
或 `ECDSA-P256` 之一。

<!--
## Choosing certificate validity period {#choosing-cert-validity-period}

kubeadm allows you to choose the validity period of CA and leaf certificates.
That can be done by using the `certificateValidityPeriod` and `caCertificateValidityPeriod`
fields of the kubeadm configuration:
-->
## 選擇證書有效期  {#choosing-cert-validity-period}

kubeadm 允許你選擇 CA 和 leaf 證書的有效期。
這可以通過使用 kubeadm 設定的 `certificateValidityPeriod` 和 `caCertificateValidityPeriod`
字段來完成：

<!--
```yaml
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
certificateValidityPeriod: 8760h # Default: 365 days × 24 hours = 1 year
caCertificateValidityPeriod: 87600h # Default: 365 days × 24 hours * 10 = 10 years
```
-->
```yaml
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
certificateValidityPeriod: 8760h # 默認：365 天 × 24 小時 = 1 年
caCertificateValidityPeriod: 87600h # 默認：365 天 × 24 小時 * 10 = 10 年
```

<!--
The values of the fields follow the accepted format for
[Go's `time.Duration` values](https://pkg.go.dev/time#ParseDuration), with the longest supported
unit being `h` (hours).
-->
字段的值遵循 [Go 語言的 `time.Duration` 格式](https://pkg.go.dev/time#ParseDuration)，
支持的最長單位爲 `h`（小時）。

<!--
## External CA mode {#external-ca-mode}

It is also possible to provide only the `ca.crt` file and not the
`ca.key` file (this is only available for the root CA file, not other cert pairs).
If all other certificates and kubeconfig files are in place, kubeadm recognizes
this condition and activates the "External CA" mode. kubeadm will proceed without the
CA key on disk.
-->
## 外部 CA 模式   {#external-ca-mode}

只提供了 `ca.crt` 檔案但是不提供 `ca.key` 檔案也是可以的
（這隻對 CA 根證書可用，其它證書不可用）。
如果所有的其它證書和 kubeconfig 檔案已就緒，kubeadm 檢測到滿足以上條件就會激活
"外部 CA" 模式。kubeadm 將會在沒有 CA 密鑰檔案的情況下繼續執行。

<!--
Instead, run the controller-manager standalone with `--controllers=csrsigner` and
point to the CA certificate and key.

There are various ways to prepare the component credentials when using external CA mode.
-->
否則，kubeadm 將獨立運行 controller-manager，附加一個
`--controllers=csrsigner` 的參數，並且指明 CA 證書和密鑰。

使用外部 CA 模式時，有多種方法可以準備組件證書。

<!--
### Manual preparation of component credentials

[PKI certificates and requirements](/docs/setup/best-practices/certificates/) includes information
on how to prepare all the required by kubeadm component credentials manually.

This guide covers the usage of the `openssl` command (used for manual certificate signing,
if you choose that approach), but you can use your preferred tools.
-->
### 手動準備組件證書   {#manual-preparation-of-component-credentials}

[PKI 證書和要求](/zh-cn/docs/setup/best-practices/certificates/)包含有關如何手動準備
kubeadm 組件證書所需的所有資訊。

本指南將介紹如何使用 `openssl` 命令（用於手動證書籤名），但你可以使用你喜歡的工具。

<!--
### Preparation of credentials by signing CSRs generated by kubeadm

kubeadm can [generate CSR files](#signing-csr) that you can sign manually with tools like
`openssl` and your external CA. These CSR files will include all the specification for credentials
that components deployed by kubeadm require.
-->
### 通過簽署 kubeadm 生成的 CSR 來準備證書   {#preparation-of-credentials-by-signing-csrs-generated-by-kubeadm}

kubeadm 可以[生成 CSR 檔案](#signing-csr)，你可以使用 `openssl` 和外部 CA 等工具手動簽署這些檔案。
這些 CSR 檔案將包含 kubeadm 部署的組件所需的所有證書規範。

<!--
### Automated preparation of component credentials by using kubeadm phases

Alternatively, it is possible to use kubeadm phase commands to automate this process.
-->
### 使用 kubeadm 階段自動準備組件證書   {#automated-preparation-of-component-credentials-by-using-kubeadm-phases}

或者，可以使用 kubeadm 階段命令來自動化此過程。

<!--
- Go to a host that you want to prepare as a kubeadm control plane node with external CA.
- Copy the external CA files `ca.crt` and `ca.key` that you have into `/etc/kubernetes/pki` on the node.
- Prepare a temporary [kubeadm configuration file](/docs/reference/setup-tools/kubeadm/kubeadm-init/#config-file)
  called `config.yaml` that can be used with `kubeadm init`. Make sure that this file includes
  any relevant cluster wide or host-specific information that could be included in certificates, such as,
  `ClusterConfiguration.controlPlaneEndpoint`, `ClusterConfiguration.certSANs` and `InitConfiguration.APIEndpoint`.
- On the same host execute the commands `kubeadm init phase kubeconfig all --config config.yaml` and
  `kubeadm init phase certs all --config config.yaml`. This will generate all required kubeconfig
  files and certificates under `/etc/kubernetes/` and its `pki` sub directory.
-->
- 登錄到將作爲具有外部 CA 的 kubeadm 控制平面節點的主機。
- 將外部 CA 檔案 `ca.crt` 和 `ca.key` 複製到節點上的 `/etc/kubernetes/pki` 目錄中。
- 準備一個名爲 `config.yaml` 的臨時 [kubeadm 設定檔案](/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-init/#config-file)，
  該檔案可以用在 `kubeadm init` 命令中。確保此檔案包含可包含在證書中的叢集範圍或特定於主機的所有重要資訊，
  例如 `ClusterConfiguration.controlPlaneEndpoint`、`ClusterConfiguration.certSANs` 和 `InitConfiguration.APIEndpoint`。
- 在同一主機上執行命令 `kubeadm init stage kubeconfig all --config config.yaml` 和
  `kubeadm init stage certs all --config config.yaml`。
  這些操作將在 `/etc/kubernetes/` 及其 `pki` 子目錄下生成所有必需的 kubeconfig 檔案和證書。
<!--
- Inspect the generated files. Delete `/etc/kubernetes/pki/ca.key`, delete or move to a safe location
  the file `/etc/kubernetes/super-admin.conf`.
- On nodes where `kubeadm join` will be called also delete `/etc/kubernetes/kubelet.conf`.
  This file is only required on the first node where `kubeadm init` will be called.
- Note that some files such `pki/sa.*`, `pki/front-proxy-ca.*` and `pki/etc/ca.*` are
  shared between control plane nodes, You can generate them once and
  [distribute them manually](/docs/setup/production-environment/tools/kubeadm/high-availability/#manual-certs)
  to nodes where `kubeadm join` will be called, or you can use the
  [`--upload-certs`](/docs/setup/production-environment/tools/kubeadm/high-availability/#stacked-control-plane-and-etcd-nodes)
  functionality of `kubeadm init` and `--certificate-key` of `kubeadm join` to automate this distribution.
-->
- 檢查所生成的檔案。刪除 `/etc/kubernetes/pki/ca.key`，刪除或移動 `/etc/kubernetes/super-admin.conf` 檔案到安全的位置。
- 在將執行 `kubeadm join` 的節點上還需要刪除 `/etc/kubernetes/kubelet.conf`，
  僅在將執行 `kubeadm init` 的第一個節點上需要此檔案。
- 請注意，一些檔案如 `pki/sa.*`、`pki/front-proxy-ca.*` 和 `pki/etc/ca.*`
  在控制平面各節點上是相同的，你可以一次性生成它們並[手動將其分發](/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/#manual-certs)到將執行
  `kubeadm join` 的節點，或者你可以使用 `kubeadm init` 的
  [`--upload-certs`](/zh-cn/docs/setup/product-environment/tools/kubeadm/high-availability/#stacked-control-plane-and-etcd-nodes)
  和 `kubeadm join` 的 `--certificate-key` 特性來執行自動分發。

<!--
Once the credentials are prepared on all nodes, call `kubeadm init` and `kubeadm join` for these nodes to
join the cluster. kubeadm will use the existing kubeconfig and certificate files under `/etc/kubernetes/`
and its `pki` sub directory.
-->
在所有節點上準備好證書後，調用 `kubeadm init` 和 `kubeadm join` 命令將這些節點加入叢集。
kubeadm 將使用 `/etc/kubernetes/` 及其 `pki` 子目錄下現有的 kubeconfig 和證書檔案。

<!--
## Certificate expiry and management {#check-certificate-expiration}
-->
## 證書過期和管理   {#check-certificate-expiration}

{{< note >}}
<!--
`kubeadm` cannot manage certificates signed by an external CA.
-->
`kubeadm` 不能管理由外部 CA 簽名的證書。
{{< /note >}}

<!--
You can use the `check-expiration` subcommand to check when certificates expire:
-->
你可以使用 `check-expiration` 子命令來檢查證書何時過期：

```shell
kubeadm certs check-expiration
```

<!--
The output is similar to this:
-->
輸出類似於以下內容：

```console
CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Dec 30, 2020 23:36 UTC   364d                                    no
apiserver                  Dec 30, 2020 23:36 UTC   364d            ca                      no
apiserver-etcd-client      Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
apiserver-kubelet-client   Dec 30, 2020 23:36 UTC   364d            ca                      no
controller-manager.conf    Dec 30, 2020 23:36 UTC   364d                                    no
etcd-healthcheck-client    Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-peer                  Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-server                Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
front-proxy-client         Dec 30, 2020 23:36 UTC   364d            front-proxy-ca          no
scheduler.conf             Dec 30, 2020 23:36 UTC   364d                                    no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Dec 28, 2029 23:36 UTC   9y              no
etcd-ca                 Dec 28, 2029 23:36 UTC   9y              no
front-proxy-ca          Dec 28, 2029 23:36 UTC   9y              no
```

<!--
The command shows expiration/residual time for the client certificates in the
`/etc/kubernetes/pki` folder and for the client certificate embedded in the kubeconfig files used
by kubeadm (`admin.conf`, `controller-manager.conf` and `scheduler.conf`).
-->
該命令顯示 `/etc/kubernetes/pki` 檔案夾中的客戶端證書以及
kubeadm（`admin.conf`、`controller-manager.conf` 和 `scheduler.conf`）
使用的 kubeconfig 檔案中嵌入的客戶端證書的到期時間/剩餘時間。

<!--
Additionally, kubeadm informs the user if the certificate is externally managed; in this case, the
user should take care of managing certificate renewal manually/using other tools.
-->
另外，kubeadm 會通知使用者證書是否由外部管理；
在這種情況下，使用者應該小心的手動/使用其他工具來管理證書更新。

<!--
The `kubelet.conf` configuration file is not included in the list above because kubeadm
configures kubelet
for [automatic certificate renewal](/docs/tasks/tls/certificate-rotation/)
with rotatable certificates under `/var/lib/kubelet/pki`.
To repair an expired kubelet client certificate see
[Kubelet client certificate rotation fails](/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/#kubelet-client-cert).
-->
上面的列表中沒有包含 `kubelet.conf` 設定檔案，因爲 kubeadm 將 kubelet
設定爲[自動更新證書](/zh-cn/docs/tasks/tls/certificate-rotation/)。
輪換的證書位於目錄 `/var/lib/kubelet/pki`。
要修復過期的 kubelet 客戶端證書，請參閱
[kubelet 客戶端證書輪換失敗](/zh-cn/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/#kubelet-client-cert)。

{{< note >}}
<!--
On nodes created with `kubeadm init` from versions prior to kubeadm version 1.17, there is a
[bug](https://github.com/kubernetes/kubeadm/issues/1753) where you manually have to modify the
contents of `kubelet.conf`. After `kubeadm init` finishes, you should update `kubelet.conf` to
point to the rotated kubelet client certificates, by replacing `client-certificate-data` and
`client-key-data` with:
-->
在通過 kubeadm 1.17 之前的版本以 `kubeadm init` 創建的節點上，
有一個[缺陷](https://github.com/kubernetes/kubeadm/issues/1753)，
該缺陷使得你必須手動修改 `kubelet.conf` 檔案的內容。
`kubeadm init` 操作結束之後，你必須更新 `kubelet.conf` 檔案將 `client-certificate-data`
和 `client-key-data` 改爲如下所示的內容以便使用輪換後的 kubelet 客戶端證書：

```yaml
client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem
client-key: /var/lib/kubelet/pki/kubelet-client-current.pem
```
{{< /note >}}

<!--
## Automatic certificate renewal

kubeadm renews all the certificates during control plane
[upgrade](/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/).
-->
## 自動更新證書 {#automatic-certificate-renewal}

kubeadm
會在控制面[升級](/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/)的時候更新所有證書。

<!--
This feature is designed for addressing the simplest use cases;
if you don't have specific requirements on certificate renewal and perform Kubernetes version
upgrades regularly (less than 1 year in between each upgrade), kubeadm will take care of keeping
your cluster up to date and reasonably secure.
-->
這個功能旨在解決最簡單的用例；如果你對此類證書的更新沒有特殊要求，
並且定期執行 Kubernetes 版本升級（每次升級之間的間隔時間少於 1 年），
則 kubeadm 將確保你的叢集保持最新狀態並保持合理的安全性。

<!--
If you have more complex requirements for certificate renewal, you can opt out from the default
behavior by passing `--certificate-renewal=false` to `kubeadm upgrade apply` or to `kubeadm
upgrade node`.
-->
如果你對證書更新有更復雜的需求，則可通過將 `--certificate-renewal=false` 傳遞給
`kubeadm upgrade apply` 或者 `kubeadm upgrade node`，從而選擇不採用預設行爲。

<!--
## Manual certificate renewal

You can renew your certificates manually at any time with the `kubeadm certs renew` command,
with the appropriate command line options. If you are running cluster with a replicated control
plane, this command needs to be executed on all the control-plane nodes.
-->
## 手動更新證書 {#manual-certificate-renewal}

你能隨時通過 `kubeadm certs renew` 命令手動更新你的證書，只需帶上合適的命令列選項。
如果你正在運行的叢集具有多副本的控制平面，則需要在所有控制平面節點上執行此命令。

<!--
This command performs the renewal using CA (or front-proxy-CA) certificate and key stored in `/etc/kubernetes/pki`.

`kubeadm certs renew` uses the existing certificates as the authoritative source for attributes
(Common Name, Organization, subject alternative name) and does not rely on the `kubeadm-config`
ConfigMap.
Even so, the Kubernetes project recommends keeping the served certificate and the associated
values in that ConfigMap synchronized, to avoid any risk of confusion.

After running the command you should restart the control plane Pods. This is required since
dynamic certificate reload is currently not supported for all components and certificates.
[Static Pods](/docs/tasks/configure-pod-container/static-pod/) are managed by the local kubelet
and not by the API Server, thus kubectl cannot be used to delete and restart them.
To restart a static Pod you can temporarily remove its manifest file from `/etc/kubernetes/manifests/`
and wait for 20 seconds (see the `fileCheckFrequency` value in [KubeletConfiguration struct](/docs/reference/config-api/kubelet-config.v1beta1/).
The kubelet will terminate the Pod if it's no longer in the manifest directory.
You can then move the file back and after another `fileCheckFrequency` period, the kubelet will recreate
the Pod and the certificate renewal for the component can complete.
-->
此命令用 CA（或者 front-proxy-CA ）證書和儲存在 `/etc/kubernetes/pki` 中的密鑰執行更新。

`kubeadm certs renew` 使用現有的證書作爲屬性（Common Name、Organization、SAN 等）的權威來源，
而不依賴於 `kubeadm-config` ConfigMap。強烈建議使它們保持同步。
即便如此，Kubernetes 項目仍然建議使用的證書與 ConfigMap 中的關聯值保持同步，以避免任何混淆的風險。

執行完此命令之後你需要重啓控制面 Pod。因爲動態證書重載目前還不被所有組件和證書支持，所有這項操作是必須的。
[靜態 Pod](/zh-cn/docs/tasks/configure-pod-container/static-pod/) 是被本地 kubelet
而不是 API 伺服器管理，所以 kubectl 不能用來刪除或重啓他們。
要重啓靜態 Pod 你可以臨時將清單檔案從 `/etc/kubernetes/manifests/` 移除並等待 20 秒
（參考 [KubeletConfiguration 結構](/zh-cn/docs/reference/config-api/kubelet-config.v1beta1/)中的
`fileCheckFrequency` 值）。如果 Pod 不在清單目錄裏，kubelet 將會終止它。
在另一個 `fileCheckFrequency` 週期之後你可以將檔案移回去，kubelet 可以完成 Pod
的重建，而組件的證書更新操作也得以完成。

<!--
`kubeadm certs renew` can renew any specific certificate or, with the subcommand `all`, it can renew all of them:
-->
`kubeadm certs renew` 可以更新任何特定的證書，或者使用子命令 `all` 更新所有的證書：

<!--
```shell
# If you are running cluster with a replicated control plane, this command
# needs to be executed on all the control-plane nodes.
kubeadm certs renew all
```
-->
```shell
# 如果你運行的集羣具有多副本的控制平面，則需要在所有控制平面節點上執行這條命令
kubeadm certs renew all
```

<!--
### Copying the administrator certificate (optional) {#admin-certificate-copy}

Clusters built with kubeadm often copy the `admin.conf` certificate into
`$HOME/.kube/config`, as instructed in [Creating a cluster with kubeadm](/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/).
On such a system, to update the contents of `$HOME/.kube/config`
after renewing the `admin.conf`, you could run the following commands:
-->
### 複製管理員證書（可選） {#admin-certificate-copy}

使用 kubeadm 構建的叢集通常會將 `admin.conf` 證書複製到 `$HOME/.kube/config`，
參閱[使用 kubeadm 創建叢集](/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)。
在這樣的系統上，若要在更新 `admin.conf` 後更新 `$HOME/.kube/config` 的內容，你可以運行以下命令：

```shell
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

<!--
## Renew certificates with the Kubernetes certificates API

This section provides more details about how to execute manual certificate renewal using the Kubernetes certificates API.
-->
## 用 Kubernetes 證書 API 更新證書 {#renew-certificates-with-the-kubernetes-certificates-api}

本節提供有關如何使用 Kubernetes 證書 API 執行手動證書更新的更多詳細資訊。

{{< caution >}}
<!--
These are advanced topics for users who need to integrate their organization's certificate
infrastructure into a kubeadm-built cluster. If the default kubeadm configuration satisfies your
needs, you should let kubeadm manage certificates instead.
-->
這些是針對需要將其組織的證書基礎結構集成到 kubeadm 構建的叢集中的使用者的高級主題。
如果預設的 kubeadm 設定滿足了你的需求，則應讓 kubeadm 管理證書。
{{< /caution >}}

<!--
### Set up a signer

The Kubernetes Certificate Authority does not work out of the box.
You can configure an external signer such as [cert-manager](https://cert-manager.io/docs/configuration/ca/),
or you can use the built-in signer.

The built-in signer is part of [`kube-controller-manager`](/docs/reference/command-line-tools-reference/kube-controller-manager/).

To activate the built-in signer, you must pass the `--cluster-signing-cert-file` and
`--cluster-signing-key-file` flags.
-->
### 設置一個簽名者（Signer） {#set-up-a-signer}

Kubernetes 證書頒發機構不是開箱即用。你可以設定外部簽名者，例如
[cert-manager](https://cert-manager.io/docs/configuration/ca/)，
也可以使用內置簽名者。

內置簽名者是
[`kube-controller-manager`](/zh-cn/docs/reference/command-line-tools-reference/kube-controller-manager/)
的一部分。

要激活內置簽名者，請傳遞 `--cluster-signing-cert-file` 和 `--cluster-signing-key-file` 參數。

<!--
If you're creating a new cluster, you can use a kubeadm
[configuration file](/docs/reference/config-api/kubeadm-config.v1beta4/):
-->
如果你正在創建一個新的叢集，你可以使用 kubeadm
的[設定檔案](/zh-cn/docs/reference/config-api/kubeadm-config.v1beta4/)：

```yaml
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
controllerManager:
  extraArgs:
  - name: "cluster-signing-cert-file"
    value: "/etc/kubernetes/pki/ca.crt"
  - name: "cluster-signing-key-file"
    value: "/etc/kubernetes/pki/ca.key"
```

<!--
### Create certificate signing requests (CSR)
-->
### 創建證書籤名請求（CSR） {#create-certificate-signing-requests-csr}

<!--
See [Create CertificateSigningRequest](/docs/reference/access-authn-authz/certificate-signing-requests/#create-certificatessigningrequest)
for creating CSRs with the Kubernetes API.
-->
有關使用 Kubernetes API 創建 CSR 的資訊，
請參見[創建 CertificateSigningRequest](/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#create-certificatessigningrequest)。

<!--
## Renew certificates with external CA

This section provide more details about how to execute manual certificate renewal using an external CA.
-->
## 通過外部 CA 更新證書 {#renew-certificates-with-external-ca}

本節提供有關如何使用外部 CA 執行手動更新證書的更多詳細資訊。

<!--
To better integrate with external CAs, kubeadm can also produce certificate signing requests (CSRs).
A CSR represents a request to a CA for a signed certificate for a client.
In kubeadm terms, any certificate that would normally be signed by an on-disk CA can be produced
as a CSR instead. A CA, however, cannot be produced as a CSR.
-->
爲了更好的與外部 CA 集成，kubeadm 還可以生成證書籤名請求（CSR）。
CSR 表示向 CA 請求客戶的簽名證書。
在 kubeadm 術語中，通常由磁盤 CA 簽名的任何證書都可以作爲 CSR 生成。但是，CA 不能作爲 CSR 生成。

<!--
### Renewal by using certificate signing requests (CSR)

Renewal of ceritficates is possible by generating new CSRs and signing them with the external CA.
For more details about working with CSRs generated by kubeadm see the section
[Signing certificate signing requests (CSR) generated by kubeadm](#signing-csr).
-->
### 使用證書籤名請求（CSR）續訂   {#renewal-by-using-certificate-signing-requests-csr}

可以通過生成新的 CSR 並使用外部 CA 對其進行簽名來對證書進行續約。
有關使用 kubeadm 生成的 CSR 的更多詳細資訊，請參閱[對 kubeadm 生成的證書籤名請求（CSR）進行簽名](#signing-csr)部分。

<!--
## Certificate authority (CA) rotation {#certificate-authority-rotation}

Kubeadm does not support rotation or replacement of CA certificates out of the box.

For more information about manual rotation or replacement of CA, see [manual rotation of CA certificates](/docs/tasks/tls/manual-rotation-of-ca-certificates/).
-->
## 證書機構（CA）輪換 {#certificate-authority-rotation}

kubeadm 並不直接支持對 CA 證書的輪換或者替換。

關於手動輪換或者置換 CA 的更多資訊，
可參閱[手動輪換 CA 證書](/zh-cn/docs/tasks/tls/manual-rotation-of-ca-certificates/)。

<!--
## Enabling signed kubelet serving certificates {#kubelet-serving-certs}

By default the kubelet serving certificate deployed by kubeadm is self-signed.
This means a connection from external services like the
[metrics-server](https://github.com/kubernetes-sigs/metrics-server) to a
kubelet cannot be secured with TLS.

To configure the kubelets in a new kubeadm cluster to obtain properly signed serving
certificates you must pass the following minimal configuration to `kubeadm init`:
-->
## 啓用已簽名的 kubelet 服務證書 {#kubelet-serving-certs}

預設情況下，kubeadm 所部署的 kubelet 服務證書是自簽名（Self-Signed）。
這意味着從 [metrics-server](https://github.com/kubernetes-sigs/metrics-server)
這類外部服務發起向 kubelet 的鏈接時無法使用 TLS 來完成保護。

要在新的 kubeadm 叢集中設定 kubelet 以使用被正確簽名的服務證書，
你必須向 `kubeadm init` 傳遞如下最小設定資料：

```yaml
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
serverTLSBootstrap: true
```

<!--
If you have already created the cluster you must adapt it by doing the following:
 - Find and edit the `kubelet-config` ConfigMap in the `kube-system` namespace.
In that ConfigMap, the `kubelet` key has a
[KubeletConfiguration](/docs/reference/config-api/kubelet-config.v1beta1/)
document as its value. Edit the KubeletConfiguration document to set `serverTLSBootstrap: true`.
- On each node, add the `serverTLSBootstrap: true` field in `/var/lib/kubelet/config.yaml`
and restart the kubelet with `systemctl restart kubelet`
-->
如果你已經創建了叢集，你必須通過執行下面的操作來完成適配：

- 找到 `kube-system` 名字空間中名爲 `kubelet-config`
  的 ConfigMap 並編輯之。
  在該 ConfigMap 中，`kubelet` 鍵下面有一個
  [KubeletConfiguration](/zh-cn/docs/reference/config-api/kubelet-config.v1beta1/)
  文檔作爲其取值。編輯該 KubeletConfiguration 文檔以設置
  `serverTLSBootstrap: true`。
- 在每個節點上，在 `/var/lib/kubelet/config.yaml` 檔案中添加
  `serverTLSBootstrap: true` 字段，並使用 `systemctl restart kubelet`
  來重啓 kubelet。

<!--
The field `serverTLSBootstrap: true` will enable the bootstrap of kubelet serving
certificates by requesting them from the `certificates.k8s.io` API. One known limitation
is that the CSRs (Certificate Signing Requests) for these certificates cannot be automatically
approved by the default signer in the kube-controller-manager -
[`kubernetes.io/kubelet-serving`](/docs/reference/access-authn-authz/certificate-signing-requests/#kubernetes-signers).
This will require action from the user or a third party controller.

These CSRs can be viewed using:
-->
字段 `serverTLSBootstrap` 將允許啓動引導 kubelet 的服務證書，方式是從
`certificates.k8s.io` API 處讀取。這種方式的一種侷限在於這些證書的
CSR（證書籤名請求）不能被 kube-controller-manager 中預設的簽名組件
[`kubernetes.io/kubelet-serving`](/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#kubernetes-signers)
批准。需要使用者或者第三方控制器來執行此操作。

可以使用下面的命令來查看 CSR：

```shell
kubectl get csr
```

```console
NAME        AGE     SIGNERNAME                        REQUESTOR                      CONDITION
csr-9wvgt   112s    kubernetes.io/kubelet-serving     system:node:worker-1           Pending
csr-lz97v   1m58s   kubernetes.io/kubelet-serving     system:node:control-plane-1    Pending
```

<!--
To approve them you can do the following:
-->
你可以執行下面的操作來批准這些請求：

```shell
kubectl certificate approve <CSR-名稱>
```

<!--
By default, these serving certificate will expire after one year. Kubeadm sets the
`KubeletConfiguration` field `rotateCertificates` to `true`, which means that close
to expiration a new set of CSRs for the serving certificates will be created and must
be approved to complete the rotation. To understand more see
[Certificate Rotation](/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/#certificate-rotation).
-->
預設情況下，這些服務證書會在一年後過期。
kubeadm 將 `KubeletConfiguration` 的 `rotateCertificates` 字段設置爲
`true`；這意味着證書快要過期時，會生成一組針對服務證書的新的 CSR，而這些
CSR 也要被批准才能完成證書輪換。要進一步瞭解這裏的細節，
可參閱[證書輪換](/zh-cn/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/#certificate-rotation)文檔。

<!--
If you are looking for a solution for automatic approval of these CSRs it is recommended
that you contact your cloud provider and ask if they have a CSR signer that verifies
the node identity with an out of band mechanism.
-->
如果你在尋找一種能夠自動批准這些 CSR 的解決方案，建議你與你的雲提供商聯繫，
詢問他們是否有 CSR 簽名組件，用來以帶外（out-of-band）的方式檢查節點的標識符。

{{% thirdparty-content %}}

<!--
Third party custom controllers can be used:
- [kubelet-csr-approver](https://github.com/postfinance/kubelet-csr-approver)

Such a controller is not a secure mechanism unless it not only verifies the CommonName
in the CSR but also verifies the requested IPs and domain names. This would prevent
a malicious actor that has access to a kubelet client certificate to create
CSRs requesting serving certificates for any IP or domain name.
-->
也可以使用第三方定製的控制器：

- [kubelet-csr-approver](https://github.com/postfinance/kubelet-csr-approver)

除非既能夠驗證 CSR 中的 CommonName，也能檢查請求的 IP 和域名，
這類控制器還算不得安全的機制。
只有完成徹底的檢查，纔有可能避免有惡意的、能夠訪問 kubelet 客戶端證書的第三方爲任何
IP 或域名請求服務證書。

<!--
## Generating kubeconfig files for additional users {#kubeconfig-additional-users}
-->
## 爲其他使用者生成 kubeconfig 檔案 {#kubeconfig-additional-users}

<!--
During cluster creation, `kubeadm init` signs the certificate in the `super-admin.conf`
to have `Subject: O = system:masters, CN = kubernetes-super-admin`.
[`system:masters`](/docs/reference/access-authn-authz/rbac/#user-facing-roles)
is a break-glass, super user group that bypasses the authorization layer (for example,
[RBAC](/docs/reference/access-authn-authz/rbac/)). The file `admin.conf` is also created
by kubeadm on control plane nodes and it contains a certificate with
`Subject: O = kubeadm:cluster-admins, CN = kubernetes-admin`. `kubeadm:cluster-admins`
is a group logically belonging to kubeadm. If your cluster uses RBAC
(the kubeadm default), the `kubeadm:cluster-admins` group is bound to the
[`cluster-admin`](/docs/reference/access-authn-authz/rbac/#user-facing-roles) ClusterRole.
-->
在叢集創建過程中，`kubeadm init` 對 `super-admin.conf` 中的證書進行簽名時，將其設定爲
`Subject: O = system:masters, CN = kubernetes-super-admin`。
[`system:masters`](/zh-cn/docs/reference/access-authn-authz/rbac/#user-facing-roles)
是一個例外的超級使用者組，可以繞過鑑權層（例如 [RBAC](/zh-cn/docs/reference/access-authn-authz/rbac/)）。
檔案 `admin.conf` 也由 kubeadm 在控制平面節點上創建，此檔案包含設爲
`Subject: O = kubeadm:cluster-admins, CN = kubernetes-admin` 的證書。
`kubeadm:cluster-admins` 是一個邏輯上屬於 kubeadm 的組。
如果你的叢集使用 RBAC（kubeadm 的預設設置），則 `kubeadm:cluster-admins`
組被綁定到 [`cluster-admin`](/zh-cn/docs/reference/access-authn-authz/rbac/#user-facing-roles) ClusterRole。

{{< warning >}}
<!--
Avoid sharing the `super-admin.conf` or `admin.conf` files. Instead, create least
privileged access even for people who work as administrators and use that least
privilege alternative for anything other than break-glass (emergency) access.
-->
避免共享 `super-admin.conf` 或 `admin.conf` 檔案。
實際上，即使是管理員等工作人員，也只爲其創建最小訪問權限，
這種最小權限的方案適用於除例外（應急）訪問之外的所有場景。
{{< /warning >}}

<!--
You can use the [`kubeadm kubeconfig user`](/docs/reference/setup-tools/kubeadm/kubeadm-kubeconfig)
command to generate kubeconfig files for additional users.
The command accepts a mixture of command line flags and
[kubeadm configuration](/docs/reference/config-api/kubeadm-config.v1beta4/) options.
The generated kubeconfig will be written to stdout and can be piped to a file using
`kubeadm kubeconfig user ... > somefile.conf`.
-->
你可以使用 [`kubeadm kubeconfig user`](/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-kubeconfig)
命令爲其他使用者生成 kubeconfig 檔案，這個命令支持命令列參數和
[kubeadm 設定結構](/zh-cn/docs/reference/config-api/kubeadm-config.v1beta4/)。
以上命令會將 kubeconfig 打印到終端上，也可以使用 `kubeadm kubeconfig user ... > somefile.conf`
輸出到一個檔案中。

<!--
Example configuration file that can be used with `--config`:
-->
如下 kubeadm 可以在 `--config` 後加的設定檔案示例：

<!--
```yaml
# example.yaml
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
# Will be used as the target "cluster" in the kubeconfig
clusterName: "kubernetes"
# Will be used as the "server" (IP or DNS name) of this cluster in the kubeconfig
controlPlaneEndpoint: "some-dns-address:6443"
# The cluster CA key and certificate will be loaded from this local directory
certificatesDir: "/etc/kubernetes/pki"
```
-->
```yaml
# example.yaml
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
# kubernetes 將作爲 kubeconfig 中集羣名稱
clusterName: "kubernetes"
# some-dns-address:6443 將作爲集羣 kubeconfig 文件中服務地址（IP 或者 DNS 名稱）
controlPlaneEndpoint: "some-dns-address:6443"
# 從本地掛載集羣的 CA 祕鑰和 CA 證書
certificatesDir: "/etc/kubernetes/pki"
```

<!--
Make sure that these settings match the desired target cluster settings.
To see the settings of an existing cluster use:
-->
確保這些設置與所需的目標叢集設置相匹配。可以使用以下命令查看現有叢集的設置：

```shell
kubectl get cm kubeadm-config -n kube-system -o=jsonpath="{.data.ClusterConfiguration}"
```

<!--
The following example will generate a kubeconfig file with credentials valid for 24 hours
for a new user `johndoe` that is part of the `appdevs` group:
-->
以下示例將爲在 `appdevs` 組的 `johndoe` 使用者創建一個有效期爲 24 小時的 kubeconfig 檔案：

```shell
kubeadm kubeconfig user --config example.yaml --org appdevs --client-name johndoe --validity-period 24h
```

<!--
The following example will generate a kubeconfig file with administrator credentials valid for 1 week:
-->
以下示例將爲管理員創建一個有效期有一週的 kubeconfig 檔案：

```shell
kubeadm kubeconfig user --config example.yaml --client-name admin --validity-period 168h
```

<!--
## Signing certificate signing requests (CSR) generated by kubeadm {#signing-csr}

You can create certificate signing requests with `kubeadm certs generate-csr`.
Calling this command will generate `.csr` / `.key` file pairs for regular
certificates. For certificates embedded in kubeconfig files, the command will
generate a `.csr` / `.conf` pair where the key is already embedded in the `.conf` file.
-->
## 簽署由 kubeadm 生成的證書籤名請求（CSR） {#signing-csr}

`kubeadm certs generate-csr` 命令爲 kubeadm 所瞭解並管理的所有證書生成 CSR。
調用此命令將爲常規證書生成 `.csr` / `.key` 檔案對。
對於嵌入在 kubeconfig 檔案中的證書，該命令將生成一個 `.csr` / `.conf` 對，
其中密鑰已嵌入在 `.conf` 檔案中。

<!--
A CSR file contains all relevant information for a CA to sign a certificate.
kubeadm uses a
[well defined specification](/docs/setup/best-practices/certificates/#all-certificates)
for all its certificates and CSRs.
-->
CSR 檔案包含 CA 簽署證書的所有相關資訊。
kubeadm 對其所有證書和 CSR 使用[明確定義的規約](/zh-cn/docs/setup/best-practices/certificates/#all-certificates)。

<!--
The default certificate directory is `/etc/kubernetes/pki`, while the default
directory for kubeconfig files is `/etc/kubernetes`. These defaults can be
overridden with the flags `--cert-dir` and `--kubeconfig-dir`, respectively.
-->
預設證書目錄是 `/etc/kubernetes/pki`，而 kubeconfig 檔案的預設目錄是 `/etc/kubernetes`。
這些預設值可以分別使用標誌 `--cert-dir` 和 `--kubeconfig-dir` 覆蓋。

<!--
To pass custom options to `kubeadm certs generate-csr` use the `--config` flag,
which accepts a [kubeadm configuration](/docs/reference/config-api/kubeadm-config.v1beta3/)
file, similarly to commands such as `kubeadm init`. Any specification such
as extra SANs and custom IP addresses must be stored in the same configuration
file and used for all relevant kubeadm commands by passing it as `--config`.
-->
要將自定義選項傳遞給 `kubeadm certs generate-csr`，可以使用 `--config` 標誌，
此標誌接受 [kubeadm 設定](/zh-cn/docs/reference/config-api/kubeadm-config.v1beta3/)檔案，
與諸如 `kubeadm init` 這類命令相似。
所有規約（例如額外的 SAN 和自定義 IP 地址）都必須儲存在同一設定檔案中，
並通過將其作爲 `--config` 傳遞來用於所有相關的 kubeadm 命令。

{{< note >}}
<!--
This guide uses the default Kubernetes directory `/etc/kubernetes`, which requires
a super user. If you are following this guide and are using directories that you can
write to (typically, this means running `kubeadm` with `--cert-dir` and `--kubeconfig-dir`)
then you can omit the `sudo` command.

You must then copy the files that you produced over to within the `/etc/kubernetes`
directory so that `kubeadm init` or `kubeadm join` will find them.
-->
本指南使用預設的 Kubernetes 目錄 `/etc/kubernetes`，需要超級使用者權限。
如果你按照本指南使用你可以寫入的目錄
（通常這意味着使用 `--cert-dir` 和 `--kubeconfig-dir` 運行 `kubeadm`），你可以省略 `sudo` 命令。

然後，你必須將生成的檔案複製到 `/etc/kubernetes` 目錄下，以便 `kubeadm init`
或 `kubeadm join` 能夠找到它們。
{{< /note >}}

<!--
### Preparing CA and service account files

On the primary control plane node, where `kubeadm init` will be executed, call the following
commands:
-->
### 準備 CA 和服務帳戶檔案   {#preparing-ca-and-service-account-files}

在將執行` kubeadm init` 的主控制平面節點上，執行以下命令：

```shell
sudo kubeadm init phase certs ca
sudo kubeadm init phase certs etcd-ca
sudo kubeadm init phase certs front-proxy-ca
sudo kubeadm init phase certs sa
```

<!--
This will populate the folders `/etc/kubernetes/pki` and `/etc/kubernetes/pki/etcd`
with all self-signed CA files (certificates and keys) and service account (public and
private keys) that kubeadm needs for a control plane node.
-->
這些操作將使用 kubeadm 所需的所有自簽名 CA 檔案（證書和密鑰）
以及服務帳戶（公鑰和私鑰）填充控制平面節點的 `/etc/kubernetes/pki`
和 `/etc/kubernetes/pki/etcd` 目錄。

{{< note >}}
<!--
If you are using an external CA, you must generate the same files out of band and manually
copy them to the primary control plane node in `/etc/kubernetes`.

Once all CSRs are signed, you can delete the root CA key (`ca.key`) as noted in the
[External CA mode](#external-ca-mode) section.
-->
如果你使用外部 CA，則你必須在帶外生成相同的檔案，並手動將它們複製到主控制平面節點上的 `/etc/kubernetes`。

所有 CSR 被簽名後，你可以刪除根 CA 密鑰（`ca.key`），如[外部 CA 模式](#external-ca-mode)部分中所述。
{{< /note >}}

<!--
For secondary control plane nodes (`kubeadm join --control-plane`) there is no need to call
the above commands. Depending on how you setup the
[High Availability](/docs/setup/production-environment/tools/kubeadm/high-availability)
cluster, you either have to manually copy the same files from the primary
control plane node, or use the automated `--upload-certs` functionality of `kubeadm init`.
-->
對於輔助控制平面節點（`kubeadm join --control-plane`），無需執行前述命令。
根據你部署[高可用](/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability)叢集的方式，
你要麼從主控制平面節點手動複製相同的檔案，要麼使用 `kubeadm init` 的 `--upload-certs` 特性實現自動化分發。

<!--
### Generate CSRs

The `kubeadm certs generate-csr` command generates CSRs for all known certificates
managed by kubeadm. Once the command is done you must manually delete `.csr`, `.conf`
or `.key` files that you don't need.
-->
### 生成 CSR   {#generate-csrs}

`kubeadm certs generate-csr` 命令爲 kubeadm 所瞭解並管理的所有證書生成 CSR。
命令完成後，你必須手動刪除不需要的 `.csr`、`.conf` 或 `.key` 檔案。

<!--
#### Considerations for kubelet.conf {#considerations-kubelet-conf}

This section applies to both control plane and worker nodes.

If you have deleted the `ca.key` file from control plane nodes
([External CA mode](#external-ca-mode)), the active kube-controller-manager in
this cluster will not be able to sign kubelet client certificates. If no external
method for signing these certificates exists in your setup (such as an
[external signer](#set-up-a-signer), you could manually sign the `kubelet.conf.csr`
as explained in this guide.
-->
#### kubelet.conf 的注意事項   {#considerations-kubelet-conf}

本節適用於控制平面和工作節點。

如果你從控制平面節點（[外部 CA 模式](#external-ca-mode)）上刪除了 `ca.key` 檔案，
則該叢集中的運行的 kube-controller-manager 將無法簽署 kubelet 客戶端證書。
如果你的設置中不存在用於簽署這些證書的外部方法
（例如[外部簽名者](#set-up-a-signer)），你可以按照本指南中的說明手動簽署 `kubelet.conf.csr`。

<!--
Note that this also means that the automatic
[kubelet client certificate rotation](/docs/tasks/tls/certificate-rotation/#enabling-client-certificate-rotation)
will be disabled. If so, close to certificate expiration, you must generate
a new `kubelet.conf.csr`, sign the certificate, embed it in `kubelet.conf`
and restart the kubelet.

If this does not apply to your setup, you can skip processing the `kubelet.conf.csr`
on secondary control plane and on workers nodes (all nodes that call `kubeadm join ...`).
That is because the active kube-controller-manager will be responsible
for signing new kubelet client certificates.
-->
請注意，這也意味着自動
[kubelet 客戶端證書輪換](/zh-cn/docs/tasks/tls/certificate-rotation/#enabling-client-certificate-rotation)將被禁用。
如果是這樣，在證書即將到期時，你必須生成新的 `kubelet.conf.csr`，簽署證書，
將其嵌入到 `kubelet.conf` 中並重新啓動 kubelet。

如果這不適用於你的設定，你可以跳過在輔助控制平面和工作節點
（調用 `kubeadm join ...` 的所有節點）上處理 `kubelet.conf.csr`。
這是因爲所運行的 kube-controller-manager 將負責簽署新的 kubelet 客戶端證書。

{{< note >}}
<!--
Processing the `kubelet.conf.csr` on the primary control plane node
(`kubeadm init`) is required, because that is considered the node that
bootstraps the cluster and a pre-populated `kubelet.conf` is needed.

You must process the `kubelet.conf.csr` file on the primary control plane node
(the host where you originally ran `kubeadm init`). This is because `kubeadm`
considers that as the node that bootstraps the cluster, and a pre-populated
`kubelet.conf` is needed.
-->
你必須在主控制平面節點（你最初運行 `kubeadm init` 的主機）上處理 `kubelet.conf.csr`，
這是因爲 `kubeadm` 將該節點視爲引導叢集的節點，並且需要預先填充的 `kubelet.conf`。
{{< /note >}}

<!--
#### Control plane nodes

Execute the following command on primary (`kubeadm init`) and secondary
(`kubeadm join --control-plane`) control plane nodes to generate all CSR files:
-->
#### 控制平面節點

在主（`kubeadm init`）和輔助（`kubeadm join --control-plane`）
控制平面節點上執行以下命令以生成所有 CSR 檔案：

```shell
sudo kubeadm certs generate-csr
```

<!--
If external etcd is to be used, follow the
[External etcd with kubeadm](/docs/setup/production-environment/tools/kubeadm/high-availability/#external-etcd-nodes)
guide to understand what CSR files are needed on the kubeadm and etcd nodes. Other
`.csr` and `.key` files under `/etc/kubernetes/pki/etcd` can be removed.

Based on the explanation in
[Considerations for kubelet.conf](#considerations-kubelet-conf) keep or delete
the `kubelet.conf` and `kubelet.conf.csr` files.
-->
如果要使用外部 etcd，請閱讀 [kubeadm 使用外部 etcd](/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/#external-etcd-nodes)
指南瞭解 kubeadm 和 etcd 節點上需要哪些 CSR 檔案。
你可以刪除 `/etc/kubernetes/pki/etcd` 下的其他 `.csr` 和 `.key` 檔案。

根據 [kubelet.conf 的注意事項](#considerations-kubelet-conf)中的說明，
你可以決定保留或刪除 `kubelet.conf` 和 `kubelet.conf.csr` 檔案。

<!--
#### Worker nodes

Based on the explanation in
[Considerations for kubelet.conf](#considerations-kubelet-conf), optionally call:
-->
#### 工作節點

根據 [kubelet.conf 的注意事項](#considerations-kubelet-conf)中的解釋，可以選擇執行：

```shell
sudo kubeadm certs generate-csr
```

<!--
and keep only the `kubelet.conf` and `kubelet.conf.csr` files. Alternatively skip
the steps for worker nodes entirely.
-->
並僅保留 `kubelet.conf` 和 `kubelet.conf.csr` 檔案，
或者完全跳過工作節點的步驟。

<!--
### Signing CSRs for all certificates
-->
### 簽署所有證書的 CSR   {#signing-csrs-for-all-certificates}

{{< note >}}
<!--
If you are using external CA and already have CA serial number files (`.srl`) for
`openssl`, you can copy such files to a kubeadm node where CSRs will be processed.
The `.srl` files to copy are `/etc/kubernetes/pki/ca.srl`,
`/etc/kubernetes/pki/front-proxy-ca.srl` and `/etc/kubernetes/pki/etcd/ca.srl`.
The files can be then moved to a new node where CSR files will be processed.

If a `.srl` file is missing for a CA on a node, the script below will generate a new SRL file
with a random starting serial number.

To read more about `.srl` files see the
[`openssl`](https://www.openssl.org/docs/man3.0/man1/openssl-x509.html)
documentation for the `--CAserial` flag.
-->
如果你使用外部 CA 並且已經擁有 `openssl` 的 CA 序列號檔案（`.srl`），
你可以將此類檔案複製到將處理 CSR 的 kubeadm 節點。
要複製的 `.srl` 檔案有 `/etc/kubernetes/pki/ca.srl`、`/etc/kubernetes/pki/front-proxy-ca.srl`
和 `/etc/kubernetes/pki/etcd/ca.srl`。
然後可以將檔案移動到將處理 CSR 檔案的新節點。

如果節點上的 CA 缺少 `.srl` 檔案，下面的腳本將生成一個具有隨機起始序列號的新 SRL 檔案。

要了解有關 `.srl` 檔案的更多資訊，請參閱
[`openssl`](https://www.openssl.org/docs/man3.0/man1/openssl-x509.html)
關於 `--CAserial` 標誌的文檔。
{{< /note >}}

<!--
Repeat this step for all nodes that have CSR files.

Write the following script in the `/etc/kubernetes` directory, navigate to the directory
and execute the script. The script will generate certificates for all CSR files that are
present in the `/etc/kubernetes` tree.
-->
對具有 CSR 檔案的所有節點重複此步驟。

在 `/etc/kubernetes` 目錄中編寫以下腳本，進入該目錄並執行該腳本。
該腳本將爲 `/etc/kubernetes` 目錄下存在的所有 CSR 檔案生成證書。

<!--
```bash
#!/bin/bash

# Set certificate expiration time in days
DAYS=365

# Process all CSR files except those for front-proxy and etcd
find ./ -name "*.csr" | grep -v "pki/etcd" | grep -v "front-proxy" | while read -r FILE;
do
    echo "* Processing ${FILE} ..."
    FILE=${FILE%.*} # Trim the extension
    if [ -f "./pki/ca.srl" ]; then
        SERIAL_FLAG="-CAserial ./pki/ca.srl"
    else
        SERIAL_FLAG="-CAcreateserial"
    fi
    openssl x509 -req -days "${DAYS}" -CA ./pki/ca.crt -CAkey ./pki/ca.key ${SERIAL_FLAG} \
        -in "${FILE}.csr" -out "${FILE}.crt"
    sleep 2
done

# Process all etcd CSRs
find ./pki/etcd -name "*.csr" | while read -r FILE;
do
    echo "* Processing ${FILE} ..."
    FILE=${FILE%.*} # Trim the extension
    if [ -f "./pki/etcd/ca.srl" ]; then
        SERIAL_FLAG=-CAserial ./pki/etcd/ca.srl
    else
        SERIAL_FLAG=-CAcreateserial
    fi
    openssl x509 -req -days "${DAYS}" -CA ./pki/etcd/ca.crt -CAkey ./pki/etcd/ca.key ${SERIAL_FLAG} \
        -in "${FILE}.csr" -out "${FILE}.crt"
done

# Process front-proxy CSRs
echo "* Processing ./pki/front-proxy-client.csr ..."
openssl x509 -req -days "${DAYS}" -CA ./pki/front-proxy-ca.crt -CAkey ./pki/front-proxy-ca.key -CAcreateserial \
    -in ./pki/front-proxy-client.csr -out ./pki/front-proxy-client.crt
```
-->
```bash
#!/bin/bash

# 設置證書過期時間（以天爲單位）
DAYS=365

# 處理除 front-proxy 和 etcd 之外的所有 CSR 文件
find ./ -name "*.csr" | grep -v "pki/etcd" | grep -v "front-proxy" | while read -r FILE;
do
    echo "* Processing ${FILE} ..."
    FILE=${FILE%.*} # 修剪擴展名
    if [ -f "./pki/ca.srl" ]; then
        SERIAL_FLAG="-CAserial ./pki/ca.srl"
    else
        SERIAL_FLAG="-CAcreateserial"
    fi
    openssl x509 -req -days "${DAYS}" -CA ./pki/ca.crt -CAkey ./pki/ca.key ${SERIAL_FLAG} \
        -in "${FILE}.csr" -out "${FILE}.crt"
    sleep 2
done

# 處理所有 etcd CSR
find ./pki/etcd -name "*.csr" | while read -r FILE;
do
    echo "* Processing ${FILE} ..."
    FILE=${FILE%.*} # 修剪擴展名
    if [ -f "./pki/etcd/ca.srl" ]; then
        SERIAL_FLAG=-CAserial ./pki/etcd/ca.srl
    else
        SERIAL_FLAG=-CAcreateserial
    fi
    openssl x509 -req -days "${DAYS}" -CA ./pki/etcd/ca.crt -CAkey ./pki/etcd/ca.key ${SERIAL_FLAG} \
        -in "${FILE}.csr" -out "${FILE}.crt"
done

# 處理前端代理 CSR
echo "* Processing ./pki/front-proxy-client.csr ..."
openssl x509 -req -days "${DAYS}" -CA ./pki/front-proxy-ca.crt -CAkey ./pki/front-proxy-ca.key -CAcreateserial \
    -in ./pki/front-proxy-client.csr -out ./pki/front-proxy-client.crt
```

<!--
### Embedding certificates in kubeconfig files

Repeat this step for all nodes that have CSR files.

Write the following script in the `/etc/kubernetes` directory, navigate to the directory
and execute the script. The script will take the `.crt` files that were signed for
kubeconfig files from CSRs in the previous step and will embed them in the kubeconfig files.
-->
### 在 kubeconfig 檔案中嵌入證書   {#embedding-certificates-in-kubeconfig-files}

對具有 CSR 檔案的所有節點重複此步驟。

在 `/etc/kubernetes` 目錄中編寫以下腳本，進入該目錄並執行腳本。
此腳本將基於上一步從 CSR 中得到爲 kubeconfig 檔案簽名的 `.crt` 檔案，
並將它們嵌入到 kubeconfig 檔案中。

```bash
#!/bin/bash

CLUSTER=kubernetes
find ./ -name "*.conf" | while read -r FILE;
do
    echo "* Processing ${FILE} ..."
    KUBECONFIG="${FILE}" kubectl config set-cluster "${CLUSTER}" --certificate-authority ./pki/ca.crt --embed-certs
    USER=$(KUBECONFIG="${FILE}" kubectl config view -o jsonpath='{.users[0].name}')
    KUBECONFIG="${FILE}" kubectl config set-credentials "${USER}" --client-certificate "${FILE}.crt" --embed-certs
done
```

<!--
### Performing cleanup {#post-csr-cleanup}

Perform this step on all nodes that have CSR files.

Write the following script in the `/etc/kubernetes` directory, navigate to the directory
and execute the script.
-->
### 執行清理   {#post-csr-cleanup}

在具有 CSR 檔案的所有節點上執行此步驟。

在 `/etc/kubernetes` 目錄中編寫以下腳本，進入該目錄並執行腳本。

<!--
```bash
#!/bin/bash

# Cleanup CSR files
rm -f ./*.csr ./pki/*.csr ./pki/etcd/*.csr # Clean all CSR files

# Cleanup CRT files that were already embedded in kubeconfig files
rm -f ./*.crt
```
-->
```bash
#!/bin/bash

# 清理 CSR 文件
rm -f ./*.csr ./pki/*.csr ./pki/etcd/*.csr # 清理所有 CSR 文件

# 清理已嵌入 kubeconfig 文件中的 CRT 文件
rm -f ./*.crt
```

<!--
Optionally, move `.srl` files to the next node to be processed.

Optionally, if using external CA remove the `/etc/kubernetes/pki/ca.key` file,
as explained in the [External CA node](#external-ca-mode) section.
-->
（可選）將 `.srl` 檔案移動到下一個要處理的節點。

或者，如果使用外部 CA，請刪除 `/etc/kubernetes/pki/ca.key` 檔案，
如[外部 CA 節點](#external-ca-mode)部分中所述。

<!--
### kubeadm node initialization

Once CSR files have been signed and required certificates are in place on the hosts
you want to use as nodes, you can use the commands `kubeadm init` and `kubeadm join`
to create a Kubernetes cluster from these nodes. During `init` and `join`, kubeadm
uses existing certificates, encryption keys and kubeconfig files that it finds in the
`/etc/kubernetes` tree on the host's local filesystem.
-->
### kubeadm 節點初始化   {#kubeadm-node-initialization}

一旦 CSR 檔案被簽名並且所需的證書在要用作節點的主機上就位，你就可以使用命令
`kubeadm init` 和 `kubeadm join` 使用這些節點創建 Kubernetes 叢集。
在 `init` 和 `join` 期間，kubeadm 使用在主機本地檔案系統的
`/etc/kubernetes` 目錄中找到的現有證書、加密密鑰和 kubeconfig 檔案。
