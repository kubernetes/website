---
layout: blog
title: "Gateway API v0.8.0：引入服務網格支持"
date: 2023-08-29T10:00:00-08:00
slug: gateway-api-v0-8
---
<!--
layout: blog
title: "Gateway API v0.8.0: Introducing Service Mesh Support"
date: 2023-08-29T10:00:00-08:00
slug: gateway-api-v0-8
-->

<!--
***Authors:*** Flynn (Buoyant), John Howard (Google), Keith Mattix (Microsoft), Michael Beaumont (Kong), Mike Morris (independent), Rob Scott (Google)
-->
**作者：** Flynn (Buoyant), John Howard (Google), Keith Mattix (Microsoft), Michael Beaumont (Kong), Mike Morris (independent), Rob Scott (Google)

**譯者：** Xin Li (Daocloud)

<!--
We are thrilled to announce the v0.8.0 release of Gateway API! With this
release, Gateway API support for service mesh has reached [Experimental
status][status]. We look forward to your feedback!

We're especially delighted to announce that Kuma 2.3+, Linkerd 2.14+, and Istio
1.16+ are all fully-conformant implementations of Gateway API service mesh
support.
-->
我們很高興地宣佈 Gateway API 的 v0.8.0 版本發佈了！
通過此版本，Gateway API 對服務網格的支持已達到[實驗性（Experimental）狀態][status]。
我們期待你的反饋！

我們很高興地宣佈 Kuma 2.3+、Linkerd 2.14+ 和 Istio 1.16+ 都是 Gateway API
服務網格支持的完全一致實現。

<!--
## Service mesh support in Gateway API

While the initial focus of Gateway API was always ingress (north-south)
traffic, it was clear almost from the beginning that the same basic routing
concepts should also be applicable to service mesh (east-west) traffic. In
2022, the Gateway API subproject started the [GAMMA initiative][gamma], a
dedicated vendor-neutral workstream, specifically to examine how best to fit
service mesh support into the framework of the Gateway API resources, without
requiring users of Gateway API to relearn everything they understand about the
API.
-->
## Gateway API 中的服務網格支持

雖然 Gateway API 最初的重點一直是入站（南北）流量，但幾乎從最開始就比較明確，
相同的基本路由概念也應適用於服務網格（東西）流量。2022 年，Gateway API
子項目啓動了 [GAMMA 計劃][gamma]，這是一個專門的供應商中立的工作流，
旨在專門研究如何最好地將服務網格支持納入 Gateway API 資源的框架中，
而不需要 Gateway API 的使用者重新學習他們瞭解的有關 API 的一切。

<!--
Over the last year, GAMMA has dug deeply into the challenges and possible
solutions around using Gateway API for service mesh. The end result is a small
number of [enhancement proposals][geps] that subsume many hours of thought and
debate, and provide a minimum viable path to allow Gateway API to be used for
service mesh.
-->
在過去的一年中，GAMMA 深入研究了使用 Gateway API 用於服務網格的挑戰和可能的解決方案。
最終結果是少量的[增強提案][geps]，其中包含了很長時間的思考和辯論，並提供允許使用 Gateway API
用於服務網格的最短可行路徑。

<!--
### How will mesh routing work when using Gateway API?

You can find all the details in the [Gateway API Mesh routing
documentation][mesh-routing] and [GEP-1426], but the short version for Gateway
API v0.8.0 is that an HTTPRoute can now have a `parentRef` that is a Service,
rather than just a Gateway. We anticipate future GEPs in this area as we gain
more experience with service mesh use cases -- binding to a Service makes it
possible to use the Gateway API with a service mesh, but there are several
interesting use cases that remain difficult to cover.

As an example, you might use an HTTPRoute to do an A-B test in the mesh as
follows:
-->
### 當使用 Gateway API 時，網格路由將如何工作？

你可以在 [Gateway API Mesh 路由文檔][mesh-routing]和 [GEP-1426] 中找到所有詳細資訊，
但對於 Gateway API v0.8.0 的簡短的版本是現在 HTTPRoute 可以設置 `parentRef`，
它是一個 Service，而不僅僅是一個網關。隨着我們對服務網格用例的經驗不斷豐富，我們預計在這個領域會出現更多
GEP -- 綁定到 Service 使得將 Gateway API 與服務網格結合使用成爲可能，但仍有幾個有趣的用例難以覆蓋。

例如，你可以使用 HTTPRoute 在網格中進行 A-B 測試，如下所示：

```yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: bar-route
spec:
  parentRefs:
  - group: ""
    kind: Service
    name: demo-app
    port: 5000
  rules:
  - matches:
    - headers:
      - type: Exact
        name: env
        value: v1
    backendRefs:
    - name: demo-app-v1
      port: 5000
  - backendRefs:
    - name: demo-app-v2
      port: 5000
```

<!--
Any request to port 5000 of the `demo-app` Service that has the header `env:
v1` will be routed to `demo-app-v1`, while any request without that header
will be routed to `demo-app-v2` -- and since this is being handled by the
service mesh, not the ingress controller, the A/B test can happen anywhere in
the application's call graph.
-->
任何對 `demo-app` Service 5000 端口且具有 `env: v1` 表頭的請求都將被路由到 `demo-app-v1`，
而沒有該標頭的請求都將被路由到 `demo-app-v2` -- 並且由於這是由服務網格而不是
Ingress 控制器處理的，A/B 測試可以發生在應用程式的調用圖中的任何位置。

<!--
### How do I know this will be truly portable?

Gateway API has been investing heavily in conformance tests across all
features it supports, and mesh is no exception. One of the challenges that the
GAMMA initiative ran into is that many of these tests were strongly tied to
the idea that a given implementation provides an ingress controller. Many
service meshes don't, and requiring a GAMMA-conformant mesh to also implement
an ingress controller seemed impractical at best. This resulted in work
restarting on Gateway API _conformance profiles_, as discussed in [GEP-1709].
-->
### 如何確定這種方案的可移植性是真的？

Gateway API 一直在其支持的所有功能的一致性測試上投入大量資源，網格也不例外。
GAMMA 面臨的挑戰之一是，許多測試都認爲一個給定實現會提供 Ingress 控制器。
許多服務網格不提供 Ingress 控制器，要求符合 GAMMA 標準的網格同時實現 Ingress 控制器似乎並不切實際。
這導致在 Gateway API **一致性設定檔案**的工作重新啓動，如 [GEP-1709] 中所述。

<!--
The basic idea of conformance profiles is that we can define subsets of the
Gateway API, and allow implementations to choose (and document) which subsets
they conform to. GAMMA is adding a new profile, named `Mesh` and described in
[GEP-1686], which checks only the mesh functionality as defined by GAMMA. At
this point, Kuma 2.3+, Linkerd 2.14+, and Istio 1.16+ are all conformant with
the `Mesh` profile.
-->
一致性設定檔案的基本思想是，我們可以定義 Gateway API 的子集，並允許實現選擇（並記錄）他們符合哪些子集。
GAMMA 正在添加一個名爲 `Mesh` 的新設定檔案，其描述在 [GEP-1686] 中，僅檢查由 GAMMA 定義的網格功能。
此時，Kuma 2.3+、Linkerd 2.14+ 和 Istio 1.16+ 都符合 `Mesh` 設定檔案的標準。

<!--
## What else is in Gateway API v0.8.0?

This release is all about preparing Gateway API for the upcoming v1.0 release
where HTTPRoute, Gateway, and GatewayClass will graduate to GA. There are two
main changes related to this: CEL validation and API version changes.
-->
## Gateway API v0.8.0 中還有什麼？

這個版本的發佈都是爲了即將到來的 v1.0 版本做準備，其中
HTTPRoute、Gateway 和 GatewayClass 將進級爲 GA。與此相關的有兩個主要更改：
CEL 驗證和 API 版本更改。

<!--
### CEL Validation

The first major change is that Gateway API v0.8.0 is the start of a transition
from webhook validation to [CEL validation][cel] using information built into
the CRDs. That will mean different things depending on the version of
Kubernetes you're using:
-->
### CEL 驗證

第一個重大變化是，Gateway API v0.8.0 起從 Webhook 驗證轉向使用內置於
CRD 中的資訊的 [CEL 驗證][cel]。取決於你使用的 Kubernetes 版本，這一轉換的影響有些不同：

<!--
#### Kubernetes 1.25+

CEL validation is fully supported, and almost all validation is implemented in
CEL. (The sole exception is that header names in header modifier filters can
only do case-insensitive validation. There is more information in [issue
2277].)

We recommend _not_ using the validating webhook on these Kubernetes versions.
-->
#### Kubernetes 1.25+

CEL 驗證得到了完全支持，並且幾乎所有驗證都是在 CEL 中實現的。
（唯一的例外是，標頭修飾符過濾器中的標頭名稱只能進行不區分大小寫的驗證，
更多的相關資訊，請參見 [issue 2277]。）

我們建議在這些 Kubernetes 版本上不使用驗證 Webhook。

<!--
#### Kubernetes 1.23 and 1.24

CEL validation is not supported, but Gateway API v0.8.0 CRDs can still be
installed. When you upgrade to Kubernetes 1.25+, the validation included in
these CRDs will automatically take effect.

We recommend continuing to use the validating webhook on these Kubernetes
versions.
-->
#### Kubernetes 1.23 和 1.24

不支持 CEL 驗證，但仍可以安裝 Gateway API v0.8.0 CRD。
當你升級到 Kubernetes 1.25+ 時，這些 CRD 中包含的驗證將自動生效。

我們建議在這些 Kubernetes 版本上繼續使用驗證 Webhook。

<!--
#### Kubernetes 1.22 and older

Gateway API only commits to support for [5 most recent versions of
Kubernetes][supported-versions]. As such, these versions are no longer
supported by Gateway API, and unfortunately Gateway API v0.8.0 cannot be
installed on them, since CRDs containing CEL validation will be rejected.
-->
#### Kubernetes 1.22 及更早版本

Gateway API 只承諾支持[最新的 5 個 Kubernetes 版本][supported-versions]。
因此，Gateway API 不再支持這些版本，不幸的是，在這些叢集版本中無法安裝 Gateway API v0.8.0，
因爲包含 CEL 驗證的 CRD 將被拒絕。

<!--
### API Version Changes

As we prepare for a v1.0 release that will graduate Gateway, GatewayClass, and
HTTPRoute to the `v1` API Version from `v1beta1`, we are continuing the process
of moving away from `v1alpha2` for resources that have graduated to `v1beta1`.
For more information on this change and everything else included in this
release, refer to the [v0.8.0 release notes][v0.8.0 release notes].
-->
### API 版本更改

在我們所準備的 v1.0 版本中，Gateway、GatewayClass 和 HTTPRoute 都會從
`v1beta1` 升級到 `v1` API 版本，對於已升級到 `v1beta1` 的資源，我們將繼續從 `v1alpha2` 遷移的過程。

有關此更改以及此版本中包含的所有其他內容的更多資訊，請參見 [v0.8.0 發佈說明][v0.8.0 release notes]。

<!--
## How can I get started with Gateway API?

Gateway API represents the future of load balancing, routing, and service mesh
APIs in Kubernetes. There are already more than 20 [implementations][impl]
available (including both ingress controllers and service meshes) and the list
keeps growing.
-->
## 如何開始使用 Gateway API？

Gateway API 代表了 Kubernetes 中負載平衡、路由和服務網格 API 的未來。
已經有超過 20 個[實現][impl]可用（包括入口控制器和服務網格），而這一列表還在不斷增長。

<!--
If you're interested in getting started with Gateway API, take a look at the
[API concepts documentation][concepts] and check out some of the
[Guides][guides] to try it out. Because this is a CRD-based API, you can
install the latest version on any Kubernetes 1.23+ cluster.
-->
如果你有興趣開始使用 Gateway API，請查閱 [API 概念文檔][concepts] 和一些[指南][guides]以嘗試使用它。
因爲這是一個基於 CRD 的 API，所以你可以在任何 Kubernetes 1.23+ 叢集上安裝最新版本。

<!--
If you're specifically interested in helping to contribute to Gateway API, we
would love to have you! Please feel free to [open a new issue][issue] on the
repository, or join in the [discussions][disc]. Also check out the [community
page][community] which includes links to the Slack channel and community
meetings. We look forward to seeing you!!
-->
如果你有興趣爲 Gateway API 做出貢獻，我們非常歡迎你！
請隨時在倉庫中[報告問題][issue]，或加入[討論][disc]。
另請查看[社區頁面][community]，其中包含 Slack 頻道和社區會議的鏈接。
我們期待你的光臨！！

<!--
## Further Reading:

- [GEP-1324] provides an overview of the GAMMA goals and some important
  definitions. This GEP is well worth a read for its discussion of the problem
  space.
- [GEP-1426] defines how to use Gateway API route resources, such as
  HTTPRoute, to manage traffic within a service mesh.
- [GEP-1686] builds on the work of [GEP-1709] to define a _conformance
  profile_ for service meshes to be declared conformant with Gateway API.
-->
## 進一步閱讀：

- [GEP-1324] 提供了 GAMMA 目標和一些重要定義的概述。這個 GEP 值得一讀，因爲它討論了問題空間。
- [GEP-1426] 定義瞭如何使用 Gateway API 路由資源（如 HTTPRoute）管理服務網格內的流量。
- [GEP-1686] 在 [GEP-1709] 的工作基礎上，爲聲明符合 Gateway API 的服務網格定義了一個一致性設定檔案。

<!--
Although these are [Experimental][status] patterns, note that they are available
in the [`standard` release channel][ch], since the GAMMA initiative has not
needed to introduce new resources or fields to date.
-->
雖然這些都是[實驗特性][status]，但請注意，它們可在 [standard 發佈頻道][ch]使用，
因爲 GAMMA 計劃迄今爲止不需要引入新的資源或字段。

<!--
[gamma]:https://gateway-api.sigs.k8s.io/concepts/gamma/
[status]:https://gateway-api.sigs.k8s.io/geps/overview/#status
[ch]:https://gateway-api.sigs.k8s.io/concepts/versioning/#release-channels-eg-experimental-standard
[cel]:/docs/reference/using-api/cel/
[crd]:/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/
[concepts]:https://gateway-api.sigs.k8s.io/concepts/api-overview/
[geps]:https://gateway-api.sigs.k8s.io/contributing/enhancement-requests/
[guides]:https://gateway-api.sigs.k8s.io/guides/getting-started/
[impl]:https://gateway-api.sigs.k8s.io/implementations/
[install-crds]:https://gateway-api.sigs.k8s.io/guides/getting-started/#install-the-crds
[issue]:https://github.com/kubernetes-sigs/gateway-api/issues/new/choose
[disc]:https://github.com/kubernetes-sigs/gateway-api/discussions
[community]:https://gateway-api.sigs.k8s.io/contributing/community/
[mesh-routing]:https://gateway-api.sigs.k8s.io/concepts/gamma/#how-the-gateway-api-works-for-service-mesh
[GEP-1426]:https://gateway-api.sigs.k8s.io/geps/gep-1426/
[GEP-1324]:https://gateway-api.sigs.k8s.io/geps/gep-1324/
[GEP-1686]:https://gateway-api.sigs.k8s.io/geps/gep-1686/
[GEP-1709]:https://gateway-api.sigs.k8s.io/geps/gep-1709/
[issue 2277]:https://github.com/kubernetes-sigs/gateway-api/issues/2277
[supported-versions]:https://gateway-api.sigs.k8s.io/concepts/versioning/#supported-versions
[v0.8.0 release notes]:https://github.com/kubernetes-sigs/gateway-api/releases/tag/v0.8.0
[versioning docs]:https://gateway-api.sigs.k8s.io/concepts/versioning/
-->
[gamma]:https://gateway-api.sigs.k8s.io/concepts/gamma/
[status]:https://gateway-api.sigs.k8s.io/geps/overview/#status
[ch]:https://gateway-api.sigs.k8s.io/concepts/versioning/#release-channels-eg-experimental-standard
[cel]:/zh-cn/docs/reference/using-api/cel/
[crd]:/zh-cn/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/
[concepts]:https://gateway-api.sigs.k8s.io/concepts/api-overview/
[geps]:https://gateway-api.sigs.k8s.io/contributing/enhancement-requests/
[guides]:https://gateway-api.sigs.k8s.io/guides/getting-started/
[impl]:https://gateway-api.sigs.k8s.io/implementations/
[install-crds]:https://gateway-api.sigs.k8s.io/guides/getting-started/#install-the-crds
[issue]:https://github.com/kubernetes-sigs/gateway-api/issues/new/choose
[disc]:https://github.com/kubernetes-sigs/gateway-api/discussions
[community]:https://gateway-api.sigs.k8s.io/contributing/community/
[mesh-routing]:https://gateway-api.sigs.k8s.io/concepts/gamma/#how-the-gateway-api-works-for-service-mesh
[GEP-1426]:https://gateway-api.sigs.k8s.io/geps/gep-1426/
[GEP-1324]:https://gateway-api.sigs.k8s.io/geps/gep-1324/
[GEP-1686]:https://gateway-api.sigs.k8s.io/geps/gep-1686/
[GEP-1709]:https://gateway-api.sigs.k8s.io/geps/gep-1709/
[issue 2277]:https://github.com/kubernetes-sigs/gateway-api/issues/2277
[supported-versions]:https://gateway-api.sigs.k8s.io/concepts/versioning/#supported-versions
[v0.8.0 release notes]:https://github.com/kubernetes-sigs/gateway-api/releases/tag/v0.8.0
[versioning docs]:https://gateway-api.sigs.k8s.io/concepts/versioning/
