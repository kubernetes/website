---
layout: blog
title: "Kubernetes v1.34: Відновлення після збою розширення тому (GA)"
date: 2025-09-19T10:30:00-08:00
slug: kubernetes-v1-34-recover-expansion-failure
author: >
  [Hemant Kumar](https://github.com/gnufied) (Red Hat)
translator: >
  [Андрій Головін](https://github.com/Andygol)
---

Чи робили ви коли-небудь помилку при розширенні ваших постійних томів у Kubernetes? Хотіли вказати `2TB`, але вказали `20TiB`? Ця, здавалося б, незначна проблема була досить важкою для виправлення, і проєкту знадобилося майже 5 років, щоб її виправити. [Автоматичне відновлення після розширення сховища](/docs/concepts/storage/persistent-volumes/#recovering-from-failure-when-expanding-volumes) існує вже деякий час у бета-версії; однак, з випуском v1.34, ми перевели її в **загальну доступність**.

Хоча завжди було можливо відновитися після збою розширення томів вручну, зазвичай це вимагало доступу адміністратора кластера і було нудно робити (див. вказане посилання для отримання додаткової інформації).

Що, якщо ви зробите помилку, а потім відразу усвідомите це? З Kubernetes v1.34 ви повинні мати можливість зменшити запитуваний розмір PersistentVolumeClaim (PVC) і, якщо розширення до раніше запитуваного розміру не завершилося, ви можете змінити запитуваний розмір. Kubernetes автоматично працюватиме над його виправленням. Будь-яка квота, спожита невдалим розширенням, буде повернена користувачу, а повʼязаний PersistentVolume повинен бути змінений на останній вказаний вами розмір.

Я пройду через приклад того, як все це працює.

## Зменшення розміру PVC для відновлення після невдалого розширення

Уявіть, що у вас закінчується місце на диску для одного з ваших серверів бази даних, і ви хочете розширити PVC з раніше вказаного `10TB` до `100TB`, але ви зробили помилку і вказали `1000TB`.

```yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: myclaim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1000TB # новий вказаний розмір - але неправильний!
```

Тепер у вас може закінчитися місце на диску в масиві дисків або просто вичерпані виділені квоти у вашого постачальника хмари. Але припустимо, що розширення до `1000TB` ніколи не відбудеться.

У Kubernetes v1.34 ви можете просто виправити свою помилку і запитати новий розмір PVC, який менший за помилку, за умови, що він все ще більший за початковий розмір фактичного PersistentVolume.

```yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: myclaim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100TB # Правильний розмір; має бути більшим за 10TB.
                     # Ви не можете зменшити обсяг нижче його фактичного розміру.
```

Це не вимагає втручання адміністратора. Ще краще, будь-яка надлишкова квота Kubernetes, яку ви тимчасово спожили, буде автоматично повернена.

Цей механізм відновлення після збоїв має одну умову: будь-який новий розмір, який ви вказуєте для PVC, **повинен** бути все ще більшим за початковий розмір у `.status.capacity`. Оскільки Kubernetes не підтримує зменшення ваших обʼєктів PV, ви ніколи не зможете зменшити їх до розміру, який спочатку був виділений для вашого запиту PVC.

## Поліпшене оброблення помилок і спостережуваність розширення томів

Реалізація того, що може виглядати як відносно незначна зміна, також вимагала від нас майже повністю переробити те, як працює розширення томів під капотом у Kubernetes. Існують нові поля API, доступні в обʼєктах PVC, які ви можете контролювати, щоб спостерігати за прогресом розширення томів.

### Поліпшена спостережуваність за розширенням у процесі

Ви можете запитати `.status.allocatedResourceStatus['storage']` PVC, щоб відстежувати прогрес операції розширення томів. Для типового блочного тому це має переходити між `ControllerResizeInProgress`, `NodeResizePending` і `NodeResizeInProgress` і ставати nil/порожнім, коли розширення томів завершено.

Якщо з якоїсь причини розширення томів до запитаного розміру неможливе, воно повинно відповідно перебувати в станах, таких як `ControllerResizeInfeasible` або `NodeResizeInfeasible`.

Ви також можете спостерігати за розміром, до якого Kubernetes працює, спостерігаючи за `pvc.status.allocatedResources`.

### Поліпшене оброблення помилок і звітність

Kubernetes тепер повинен повторно спробувати ваші невдалі розширення томів повільніше, він повинен робити менше запитів як до системи зберігання, так і до Kubernetes apiserver.

Помилки, виявлені під час розширення томів, тепер повідомляються як стан на обʼєктах PVC і повинні зберігатися на відміну від подій. Kubernetes тепер заповнить `pvc.status.conditions` ключами помилок `ControllerResizeError` або `NodeResizeError`, коли розширення томів не вдається.

### Виправлення давніх помилок у робочих процесах зміни розміру

Ця функція також дозволила нам виправити давні помилки в робочих процесах зміни розміру, такі як [Kubernetes issue #115294](https://github.com/kubernetes/kubernetes/issues/115294). Якщо ви спостерігаєте щось зламане, будь ласка, повідомте про свої помилки на [https://github.com/kubernetes/kubernetes/issues](https://github.com/kubernetes/kubernetes/issues/new/choose), разом з деталями про те, як відтворити проблему.

Робота над цією функцією протягом її життєвого циклу була складною, і було б неможливо досягти GA без зворотного звʼязку від [@msau42](https://github.com/msau42), [@jsafrane](https://github.com/jsafrane) і [@xing-yang](https://github.com/xing-yang).

Всі учасники, які працювали над цим, також цінують внесок, наданий [@thockin](https://github.com/thockin) і [@liggitt](https://github.com/liggitt) на різних самітах контрибʼюторів Kubernetes.
