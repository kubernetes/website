---
layout: blog
title: "Kubernetes v1.34: Mutable CSI Node Allocatable переходить в Beta"
date: 2025-09-11T10:30:00-08:00
slug: kubernetes-v1-34-mutable-csi-node-allocatable-count
author: Eddie Torres (Amazon Web Services)
translator: >
  [Андрій Головін](https://github.com/Andygol)
---

Функція [для драйверів CSI, що дозволяє оновлювати інформацію про кількість підключених томів на вузлах](https://kep.k8s.io/4876), вперше представлена в альфа-версії Kubernetes v1.33, перейшла в **бета-версію** у випуску Kubernetes v1.34! Це є важливою віхою у підвищенні точності планування podʼівв із збереженням стану шляхом зменшення кількості збоїв, спричинених застарілою інформацією про ємність підключених томів.

## Background

Традиційно, [CSI драйвери](https://kubernetes-csi.github.io/docs/introduction.html) Kubernetes повідомляють про статичний максимальний ліміт підключення томів під час ініціалізації. Однак фактичні ємності підключення можуть змінюватися протягом життєвого циклу вузла з різних причин, таких як:

- Ручні або зовнішні операції з підключення/відключення томів поза контролем Kubernetes.
- Динамічно підключені мережеві інтерфейси або спеціалізоване обладнання (GPU, NIC тощо), що споживає доступні слоти.
- Сценарії з кількома драйверами, коли операції одного драйвера CSI впливають на доступну ємність, про яку повідомляє інший.

Статичне звітування може призвести до того, що Kubernetes запланує поди на вузлах, які, здається, мають ємність, але насправді не мають, що призводить до зависання подів у стані `ContainerCreating`.

## Динамічна адаптація лімітів томів CSI

Завдяки цій новій функції Kubernetes дозволяє драйверам CSI динамічно налаштовувати та повідомляти про ємності підключення вузлів під час виконання. Це забезпечує наявність у планувальника, а також інших компонентів, які покладаються на цю інформацію, найбільш точної та актуальної інформації про ємність вузлів.

### Як це працює

Kubernetes підтримує два механізми для оновлення інформації про ліміти томів вузлів:

- **Періодичні оновлення:** Драйвери CSI вказують інтервал для періодичного оновлення виділеної ємності вузла.
- **Реактивні оновлення:** Негайне оновлення, яке викликається, коли операція підключення тому не вдається через вичерпані ресурси (помилка `ResourceExhausted`).

### Увімкнення функції

Щоб використовувати цю бета-функцію, необхідно увімкнути функціональну можливість `MutableCSINodeAllocatableCount` в компонентах:

- `kube-apiserver`
- `kubelet`

### Приклад конфігурації драйвера CSI

Нижче наведено приклад конфігурації драйвера CSI для увімкнення періодичних оновлень кожні 60 секунд:

```yaml
apiVersion: storage.k8s.io/v1
kind: CSIDriver
metadata:
  name: example.csi.k8s.io
spec:
  nodeAllocatableUpdatePeriodSeconds: 60
```

Ця конфігурація вказує kubelet періодично викликати метод `NodeGetInfo` драйвера CSI кожні 60 секунд, оновлюючи кількість виділених томів вузла. Kubernetes забезпечує мінімальний інтервал оновлення в 10 секунд, щоб збалансувати точність і використання ресурсів.

### Негайні оновлення при збоях підключення

Коли операція підключення тому не вдається через помилку `ResourceExhausted` (код gRPC `8`), Kubernetes негайно оновлює кількість виділених томів замість того, щоб чекати наступного періодичного оновлення. Kubelet потім позначає постраждалі поди як Failed, що дозволяє їх контролерам відтворити їх. Це запобігає зависанню подів у стані `ContainerCreating`.

## Як почати використовувати

Щоб увімкнути цю функцію у вашому кластері Kubernetes v1.34:

1. Увімкніть функціональну можливість `MutableCSINodeAllocatableCount` в компонентах `kube-apiserver` та `kubelet`.
2. Оновіть конфігурацію вашого драйвера CSI, встановивши `nodeAllocatableUpdatePeriodSeconds`.
3. Моніторте та спостерігайте за покращеннями в точності планування та надійності розміщення подів.

## Наступні кроки

Ця функція наразі знаходиться на стадії бета-тестування, і спільнота Kubernetes вітає ваші відгуки. Тестуйте її, діліться своїм досвідом і допомагайте спрямовувати її еволюцію до стабільності GA.

Приєднуйтесь до обговорень у [Kubernetes Storage Special Interest Group (SIG-Storage)](https://github.com/kubernetes/community/tree/master/sig-storage), щоб сформувати майбутнє можливостей зберігання Kubernetes.
