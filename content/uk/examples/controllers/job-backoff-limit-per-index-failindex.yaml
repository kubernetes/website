apiVersion: batch/v1
kind: Job
metadata:
  name: job-backoff-limit-per-index-failindex
spec:
  completions: 4
  parallelism: 2
  completionMode: Indexed
  backoffLimitPerIndex: 1
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: main
        image: docker.io/library/python:3
        command:
          # Скрипт:
          # - завершує роботу Podʼа з індексом 0 з кодом виходу 1, що призводить до однієї повторної спроби;
          # - завершує роботу Podʼа з індексом 1 з кодом виходу 42, що призводить до
          # призводить до невдачі індексу без повторної спроби.
          # - завершує роботу Podʼа з будь-яким іншим індексом.
          - python3
          - -c
          - |
            import os, sys
            index = int(os.environ.get("JOB_COMPLETION_INDEX"))
            if index == 0:
              sys.exit(1)
            elif index == 1:
              sys.exit(42)
            else:
              sys.exit(0)
  backoffLimit: 6
  podFailurePolicy:
    rules:
    - action: FailIndex
      onExitCodes:
        containerName: main
        operator: In
        values: [42]
