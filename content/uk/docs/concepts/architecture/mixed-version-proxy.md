---
title: Mixed Version Proxy
content_type: concept
weight: 220
---

<!-- огляд -->

{{< feature-state feature_gate_name="UnknownVersionInteroperabilityProxy" >}}

У Kubernetes {{< skew currentVersion >}} включено альфа-функцію, яка дозволяє {{< glossary_tooltip text="API Server" term_id="kube-apiserver" >}} проксійовати запити ресурсів до інших _рівноправних_ API-серверів. Це корисно, коли існують кілька API-серверів, що працюють на різних версіях Kubernetes в одному кластері (наприклад, під час тривалого впровадження нового релізу Kubernetes).

Це дозволяє адміністраторам кластерів налаштовувати високодоступні кластери, які можна модернізувати більш безпечно, направляючи запити на ресурси (зроблені під час оновлення) на правильний kube-apiserver. Цей проксі заважає користувачам бачити несподівані помилки 404 Not Found, які випливають з процесу оновлення.

Цей механізм називається _Mixed Version Proxy_.

## Активація Mixed Version Proxy {#enabling-the-mixed-version-proxy}

Переконайтеся, що [функціональну можливість](/docs/reference/command-line-tools-reference/feature-gates/) `UnknownVersionInteroperabilityProxy` увімкнено, коли ви запускаєте {{< glossary_tooltip text="API Server" term_id="kube-apiserver" >}}:

```shell
kube-apiserver \
--feature-gates=UnknownVersionInteroperabilityProxy=true \
# обовʼязкові аргументи командного рядка для цієї функції
--peer-ca-file=<шлях до сертифіката CA kube-apiserver>
--proxy-client-cert-file=<шлях до сертифіката агрегатора проксі>,
--proxy-client-key-file=<шлях до ключа агрегатора проксі>,
--requestheader-client-ca-file=<шлях до сертифіката CA агрегатора>,
# requestheader-allowed-names може бути встановлено як порожнє значення, щоб дозволити будь-яке Загальне Імʼя
--requestheader-allowed-names=<дійсні Загальні Імена для перевірки сертифікату клієнта проксі>,

# необовʼязкові прапорці для цієї функції
--peer-advertise-ip=`IP цього kube-apiserver, яке повинно використовуватися рівноправними для проксі-запитів`
--peer-advertise-port=`порт цього kube-apiserver, який повинен використовуватися рівноправними для проксі-запитів`

# …і інші прапорці як зазвичай
```

### Транспорт та автентифікація проксі між API-серверами {#transport-and-authn}

* Вихідний kube-apiserver повторно використовує
  [наявні прапорці автентифікації клієнта API-сервера](/docs/tasks/extend-kubernetes/configure-aggregation-layer/#kubernetes-apiserver-client-authentication) `--proxy-client-cert-file` та `--proxy-client-key-file` для представлення своєї ідентичності, яку перевіряє його рівноправний (цільовий kube-apiserver). Цей останній підтверджує підключення рівноправного на основі конфігурації, яку ви вказуєте за допомогою аргументу командного рядка `--requestheader-client-ca-file`.

* Для автентифікації сертифікатів серверів призначення вам слід налаштувати пакет сертифіката організації, вказавши аргумент командного рядка `--peer-ca-file` **вихідному** API-серверу.

### Налаштування для зʼєднання з рівноправним API-сервером {#configuring-for-peer-api-server-connectivity}

Для встановлення мережевого розташування kube-apiserver, яке партнери будуть використовувати для проксі-запитів, використовуйте аргументи командного рядка `--peer-advertise-ip` та `--peer-advertise-port` для kube-apiserver або вказуйте ці поля в конфігураційному файлі API-сервера. Якщо ці прапорці не вказані, партнери будуть використовувати значення з аргументів командного рядка `--advertise-address` або `--bind-address` для kube-apiserver. Якщо ці прапорці теж не встановлені, використовується типовий інтерфейс хосту.

## Mixed version proxying

При активації Mixed version proxying [шар агрегації](/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/) завантажує спеціальний фільтр, який виконує такі дії:

* Коли запит ресурсу надходить до API-сервера, який не може обслуговувати цей API (чи то тому, що він є версією, що передує введенню API, чи тому, що API вимкнено на API-сервері), API-сервер намагається надіслати запит до рівноправного API-сервера, який може обслуговувати затребуваний API. Це відбувається шляхом ідентифікації груп API / версій / ресурсів, які місцевий сервер не визнає, і спроби проксійовати ці запити до рівноправного API-сервера, який може обробити запит.
* Якщо рівноправний API-сервер не відповідає, то _source_ API-сервер відповідає помилкою 503 ("Сервіс недоступний").

### Як це працює під капотом {#how-it-works-under-the-hood}

Коли API-сервер отримує запит ресурсу, він спочатку перевіряє, які API-сервери можуть обслуговувати затребуваний ресурс. Ця перевірка відбувається за допомогою внутрішнього [API зберігання версії](/docs/reference/generated/kubernetes-api/{{< param "version" >}}/#storageversioncondition-v1alpha1-internal-apiserver-k8s-io).

* Якщо ресурс відомий API-серверу, що отримав запит (наприклад, `GET /api/v1/pods/some-pod`), запит обробляється локально.

* Якщо для запитаного ресурсу не знайдено внутрішнього обʼєкта `StorageVersion` (наприклад, `GET /my-api/v1/my-resource`) і налаштовано APIService на проксі до  API-сервера розширення, цей проксі відбувається за звичайного [процесу](/docs/tasks/extend-kubernetes/configure-aggregation-layer/) для розширених API.

* Якщо знайдено дійсний внутрішній обʼєкт `StorageVersion` для запитаного ресурсу (наприклад, `GET /batch/v1/jobs`) і API-сервер, який намагається обробити запит (API-сервер обробників), має вимкнений API `batch`, тоді API-сервер, який обробляє запит, витягує рівноправні API-сервери, які обслуговують відповідну групу / версію / ресурс (`api/v1/batch` у цьому випадку) за інформацією у витягнутому обʼєкті `StorageVersion`.  API-сервер, який обробляє запит, потім проксіює запит до одного з вибраних рівноправних kube-apiservers які обізнані з запитаним ресурсом.

  * Якщо немає партнера, відомого для тієї групи API / версії / ресурсу, API-сервер обробників передає запит своєму власному ланцюжку обробки, який, врешті-решт, повинен повернути відповідь 404 ("Не знайдено").

  * Якщо API-сервер обробників ідентифікував і вибрав рівноправний API-сервер, але цей останній не відповідає (з причин, таких як проблеми з мережевим зʼєднанням або data race між отриманням запиту та реєстрацією інформації партнера в панелі управління), то API-сервер обробників відповідає помилкою 503 ("Сервіс недоступний").
