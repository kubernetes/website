---
title: Поради з безпеки для контролю доступу на основі ролей
description: >
  Принципи та практики для належного проєктування RBAC для операторів кластерів.
content_type: concept
weight: 60
---

<!-- overview -->

Kubernetes {{< glossary_tooltip text="RBAC" term_id="rbac" >}} є ключовим елементом безпеки, який забезпечує те, що користувачі та робочі навантаження кластера мають доступ лише до ресурсів, необхідних для виконання їх ролей. Важливо переконатися, що при проєктуванні дозволів для користувачів кластера адміністратор кластера розуміє області, де може відбуватися ескалація привілеїв, щоб зменшити ризик надмірного доступу, що може призвести до інцидентів безпеки.

Рекомендації, викладені тут, слід читати разом із загальною [документацією з RBAC](/docs/reference/access-authn-authz/rbac/#restrictions-on-role-creation-or-update).

<!-- body -->

## Загальні рекомендації {#general-good-practice}

### Принцип найменших привілеїв {#least-privilege}

Ідеально, мінімальні права RBAC повинні бути надані користувачам та службовим обліковим записам. Використовуйте лише дозволи, які явно потрібні для їхньої роботи. Хоча кожен кластер буде відрізнятися, деякі загальні правила, які можна застосувати, включають наступне:

- Надавайте дозволи на рівні простору імен, де це можливо. Використовуйте RoleBindings замість ClusterRoleBindings, щоб дати користувачам права лише в межах конкретного простору імен.
- Уникайте надання дозволів за допомогою шаблонів (*wildcard*) при можливості, особливо для всіх ресурсів. Оскільки Kubernetes є розширюваною системою, надання доступу за допомогою шаблонів надає права не лише на всі типи обʼєктів, які наразі існують у кластері, а й на всі типи обʼєктів, які будуть створені у майбутньому.
- Адміністратори не повинні використовувати облікові записи `cluster-admin`, крім випадків, коли це дійсно потрібно. Надання облікового запису з низькими привілеями з [правами знеособлення](/docs/reference/access-authn-authz/authentication/#user-impersonation) може запобігти випадковій модифікації ресурсів кластера.
- Уникайте додавання користувачів до групи `system:masters`. Будь-який користувач, який є членом цієї групи, обходить всі перевірки прав RBAC та завжди матиме необмежений доступ суперкористувача, який не може бути скасований шляхом видалення RoleBindings або ClusterRoleBindings. До речі, якщо кластер використовує вебхук авторизації, членство в цій групі також обходить цей вебхук (запити від користувачів, які є членами цієї групи, ніколи не відправляються вебхуку).

### Мінімізація розповсюдження привілейованих токенів {#minimize-distribution-of-privileged-tokens}

В ідеалі, службові облікові записи не повинні бути призначені Podʼам, які мають надані потужні дозволи (наприклад, будь-які з перерахованих [прав підвищення привілеїв](#privilege-escalation-risks)). У випадках, коли робоче навантаження вимагає потужних дозволів, розгляньте такі практики:

- Обмежте кількість вузлів, на яких запущені потужні Podʼи. Переконайтеся, що всі DaemonSets, які ви запускаєте, необхідні та запускаються з мінімальними привілеями, щоб обмежити зону поширення випадкових виходів з контейнера.
- Уникайте запуску потужних Podʼів поруч з ненадійними або публічно-експонованими. Розгляньте використання [Taints and Toleration](/docs/concepts/scheduling-eviction/taint-and-toleration/), [NodeAffinity](/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity) або [PodAntiAffinity](/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity), щоб переконатися, що Podʼи не запускаються поруч з ненадійними або менш надійними Podʼами. Особливу увагу слід приділяти ситуаціям, де менш надійні Podʼи не відповідають стандарту **Restricted** для безпеки Podʼів.

### Зміцнення захисту {#hardening}

Kubernetes типово надає доступ, який може бути непотрібним у кожному кластері. Перегляд прав RBAC, які надаються типово, може створити можливості для зміцнення безпеки. Загалом, зміни не повинні вноситися до прав, наданих `system:` обліковим записам, але існують деякі опції для зміцнення прав кластера:

- Перегляньте звʼязки для групи `system:unauthenticated` та видаліть їх, де це можливо, оскільки це надає доступ всім, хто може звертатися до сервера API на мережевому рівні.
- Уникайте автоматичного монтування токенів службового облікового запису типово, встановивши `automountServiceAccountToken: false`. Докладніше дивіться [використання токенів стандартного службового облікового запису](/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server). Встановлення цього значення для Podʼа перезапише налаштування службового облікового запису, робочі навантаження які потребують токени службового облікового запису, все ще можуть монтувати їх.

### Періодичний огляд {#periodic-review}

Важливо періодично переглядати налаштування Kubernetes RBAC для виявлення зайвих записів та можливих ескалацій привілеїв. Якщо зловмисник може створити обліковий запис користувача з такою ж назвою, як видалений користувач, він автоматично може успадкувати всі права видаленого користувача, зокрема права, призначені цьому користувачу.

## Ризики ескалації привілеїв RBAC у Kubernetes {#privilege-escalation-risks}

У Kubernetes RBAC існує кілька привілеїв, які, якщо надані, можуть дозволити користувачеві або службовому обліковому запису здійснити ескалацію своїх привілеїв у кластері або вплинути на системи за межами кластера.

Цей розділ призначений для того, щоб надати видимість тим областям, де оператори кластерів повинні бути уважними, щоб переконатися, що вони не надають більше доступу до кластерів, ніж було задумано.

### Отримання Secret {#listing-secrets}

Зазвичай зрозуміло, що надання доступу до отримання (get) Secret дозволить користувачеві переглядати їх вміст. Також важливо зауважити, що доступ до списку (list) та перегляду (watch) також фактично дозволяє користувачам розкривати вміст Secret. Наприклад, коли повертається відповідь списку (наприклад, за допомогою `kubectl get secrets -A -o yaml`), вона містить вміст усіх Secret.

### Створення робочого навантаження {#workload-creation}

Дозвіл на створення робочих навантажень (будь-то Podʼи чи [ресурси робочих навантажень](/docs/concepts/workloads/controllers/), що керують Podʼами) у просторі імен неявно надає доступ до багатьох інших ресурсів у цьому просторі імен, таких як Secret, ConfigMap та PersistentVolume, які можна монтувати в Podʼах. Крім того, оскільки Podʼи можуть працювати як будь-який [ServiceAccount](/docs/reference/access-authn-authz/service-accounts-admin/), надання дозволу на створення робочих навантажень також неявно надає рівні доступу до API будь-якого службового облікового запису у цьому просторі імен.

Користувачі, які можуть запускати привілейовані Podʼи, можуть використовувати цей доступ для отримання доступу до вузла і, можливо, подальшого підвищення своїх привілеїв. Якщо ви не повністю довіряєте користувачеві або іншому принципалу з можливістю створювати відповідні заходи безпеки та ізоляції Podʼів, вам слід застосувати стандарт безпеки Podʼів **Baseline** або **Restricted**. Ви можете використовувати [Pod Security admission](/docs/concepts/security/pod-security-admission/) або інші (сторонні) механізми для впровадження цього контролю.

З цих причин простори імен слід використовувати для розділення ресурсів, які потребують різних рівнів довіри або оренди. Краще дотримуватися принципів [найменших привілеїв](#least-privilege) і надавати мінімальний набір дозволів, але обмеження у межах простору імен слід розглядати як слабкі.

### Створення постійного тому {#persistent-volume-creation}

Якщо дозволяється комусь, або застосунку, створювати довільні постійні томи (PersistentVolumes), цей доступ включає створення томів типу `hostPath`, що означає, що Pod отримає доступ до базової файлової системи (файлових систем) вузла, з яким повʼязаний цей том. Надання такої можливості — це ризик безпеки.

Існує багато способів, за допомогою яких контейнер з необмеженим доступом до файлової системи вузла може підвищити свої привілеї, включаючи читання даних з інших контейнерів та зловживання службовими обліковими записами системи, такими як Kubelet.

Дозволяйте доступ до створення обʼєктів PersistentVolume (постійного тому) лише для:

- Користувачів (операторів кластера), які потребують цього доступу для своєї роботи, і яким ви довіряєте.
- Компонентів управління Kubernetes, які створюють обʼєкти PersistentVolume на основі PersistentVolumeClaims, які налаштовані для автоматичного розподілу. Зазвичай це налаштовано постачальником Kubernetes або оператором при встановленні драйвера CSI.

Де потрібен доступ до постійного сховища, довірені адміністратори повинні створювати PersistentVolumes, а обмежені користувачі повинні використовувати PersistentVolumeClaims для доступу до цього сховища.

### Доступ до субресурсу `proxy` обʼєктів вузлів {#access-to-proxy-subresource-of-nodes}

Користувачі, які мають доступ до субресурсу proxy обʼєктів вузлів, мають права на використання API Kubelet, що дозволяє виконувати команди на кожному Podʼі на вузлі (вузлах), до якого вони мають права доступу. Цей доступ обходить логування подій та контроль допуску, тому слід бути обережним перед наданням прав на цей ресурс.

### Escalate {#escalate-verb}

Загалом, система RBAC запобігає користувачам створювати clusterroles з більшими правами, ніж має користувач. Виняток становить дієслово `escalate`. Як вказано в [документації з RBAC](/docs/reference/access-authn-authz/rbac/#restrictions-on-role-creation-or-update), користувачі з цим правом можуть ефективно підвищувати свої привілеї.

### Bind {#bind-verb}

Схоже до дієслова `escalate`, надання користувачам цього права дозволяє обхід вбудованих захистів Kubernetes від підвищення привілеїв, що дозволяє користувачам створювати привʼязки до ролей з правами, яких вони ще не мають.

### Impersonate {#impersonate-verb}

Це дієслово дозволяє користувачам підміняти та отримувати права інших користувачів у кластері. Слід бути обережним при наданні цього права, щоб переконатися, що через один з знеособлених облікових записів не можна отримати занадто багато прав.

### Запити на підпис сертифікатів (CSRs) і видача сертифікатів {#csrs-and-certificate-issuing}

API CSRs дозволяє користувачам з правами `create` на CSRs та `update` на `certificatesigningrequests/approval` з підписантом `kubernetes.io/kube-apiserver-client` створювати нові клієнтські сертифікати, що дозволяють користувачам автентифікуватися в кластері. Ці клієнтські сертифікати можуть мати довільні імена, включаючи дублікати компонентів системи Kubernetes. Це фактично дозволить підвищення привілеїв.

### Запити токенів {#token-request}

Користувачі з правами `create` на `serviceaccounts/token` можуть створювати запити на токени для наявних службових облікових записів.

### Керування вебхуками допуску {#control-admission-webhooks}

Користувачі з контролем над `validatingwebhookconfigurations` або `mutatingwebhookconfigurations` можуть керувати вебхуками, які можуть читати будь-який обʼєкт, допущений до кластера, і, у разі мутаційних вебхуків, також змінювати допущені обʼєкти.

### Зміна Namespace {#namespace-modification}

Користувачі, які можуть виконувати операції **patch** на обʼєктах Namespace (через привʼязку до ролі (RoleBinding) з таким доступом), можуть змінювати мітки цього Namespaceʼу. У кластерах, де використовується Pod Security Admission, це може дозволити користувачу налаштувати простір імен для більш дозволених політик, ніж передбачено адміністратором. Для кластерів, де використовується NetworkPolicy, користувачам можуть бути встановлені мітки, які опосередковано дозволяють доступ до служб, доступ до яких адміністратор не мав на меті давати.

## Ризики відмови в обслуговуванні в Kubernetes RBAC {#denial-of-service-risks}

### Відмова у створенні обʼєктів {#object-creation-dos}

Користувачі, які мають права на створення обʼєктів у кластері, можуть створювати достатньо великі обʼєкти або велику кількість обʼєктів, що може призвести до умов відмови в обслуговуванні, як обговорюється в [etcd, що використовується в Kubernetes, піддається атакам типу OOM](https://github.com/kubernetes/kubernetes/issues/107325). Це може бути особливо актуальним у кластерах з кількома орендаторами, якщо користувачі з частковою довірою або користувачі без довіри мають обмежений доступ до системи.

Один зі способів попередження цієї проблеми — використовувати [обмеження ресурсів](/docs/concepts/policy/resource-quotas/#object-count-quota) для обмеження кількості обʼєктів, які можна створити.

## {{% heading "whatsnext" %}}

- Дізнайтеся більше про RBAC, переглянувши [документацію з RBAC](/docs/reference/access-authn-authz/rbac/).
