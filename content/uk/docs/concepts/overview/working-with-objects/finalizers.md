---
title: Завершувачі
content_type: concept
weight: 80
---

<!-- overview -->

{{<glossary_definition term_id="finalizer" length="long">}}

Ви можете використовувати завершувачі для управління {{<glossary_tooltip text="збиранням сміття" term_id="garbage-collection">}} з {{< glossary_tooltip text="обʼєктів" term_id="object" >}} за допомогою надсилань повідомлень {{<glossary_tooltip text="контролерам" term_id="controller">}} з вимогою виконати певні завдання з очищення перед видаленням цільового ресурсу.

Зазвичай завершувачі не вказують код для виконання. Замість цього вони являють собою списки ключів для конкретного ресурсу, аналогічні анотаціям. Kubernetes автоматично вказує деякі завершувачі, але ви також можете вказати свої.

## Як працюють завершувачі {#how-finalizers-work}

При створенні ресурсу за допомогою файлу маніфесту ви можете вказати завершувачі у полі `metadata.finalizers`. Коли ви намагаєтеся видалити ресурс, сервер API, що обробляє запит на видалення, помічає значення у полі `finalizers` і робить наступне:

* Модифікує обʼєкт, додаючи поле `metadata.deletionTimestamp` з часом, коли ви почали видалення.
* Запобігає видаленню обʼєкта, поки всі елементи не будуть видалені з його поля `metadata.finalizers`.
* Повертає код статусу `202` (HTTP "Accepted")

Контролер, який керує цим завершувачем, помічає оновлення обʼєкта і встановлення `metadata.deletionTimestamp`, що вказує на те, що було запрошене видалення обʼєкта. Контролер потім намагається виконати вимоги, вказані для цього ресурсу завершувачами. Кожного разу, коли виконується умова завершувача, контролер видаляє цей ключ із поля `finalizers` ресурсу. Коли поле `finalizers` порожнє, обʼєкт із встановленим полем `deletionTimestamp` автоматично видаляється. Ви також можете використовувати завершувачі для запобігання видаленню некерованих ресурсів.

Розповсюджений приклад завершувача — `kubernetes.io/pv-protection`, який запобігає
випадковому видаленню обʼєктів `PersistentVolume`. Коли обʼєкт `PersistentVolume`
використовується у Podʼі, Kubernetes додає завершувач `pv-protection`. Якщо ви
намагаєтеся видалити `PersistentVolume`, він потрапляє в стан `Terminating`, але
контролер не може видалити його через наявність завершувача. Коли Pod перестає
використовувати `PersistentVolume`, Kubernetes очищує завершувач `pv-protection`,
і контролер видаляє обʼєкт.

{{<note>}}

* Коли ви видаляєте обʼєкт за допомогою `DELETE`, Kubernetes додає відмітку видалення для цього обʼєкта і тут же починає обмежувати зміни в полі `.metadata.finalizers` для обʼєкта, який тепер очікує видалення. Ви можете видаляти наявні завершувачі (видаляти запис зі списку `finalizers`), але не можете додати новий завершувач. Ви також не можете модифікувати `deletionTimestamp` для обʼєкта, якщо він вже встановлений.

* Після запиту на видалення ви не можете відновити цей обʼєкт. Єдиний спосіб — видалити його і створити новий схожий обʼєкт.
{{</note>}}

{{<note>}}
Назви власних завершувачів **повинні** бути загальнодоступними кваліфікованими назвами, такими як `example.com/finalizer-name`. Kubernetes забезпечує дотримання цього формату; сервер API відхиляє запис до обʼєктів, де у змінах не використовуються кваліфіковані імена для будь-яких власних завершувачів.
{{</note>}}

## Власники, мітки та завершувачі {#owners-labels-finalizers}

Так само як і {{<glossary_tooltip text="мітки" term_id="label">}}, [посилання на власника](/docs/concepts/overview/working-with-objects/owners-dependents/) описують стосунки між обʼєктами в Kubernetes, але використовуються для іншої цілі. Коли {{<glossary_tooltip text="контролер" term_id="controller">}} керує обʼєктами типу Pod, він використовує мітки для відстеження змін у групах повʼязаних обʼєктів. Наприклад, коли {{<glossary_tooltip text="Завдання" term_id="job">}} створює один чи
декілька Podʼів, контролер Завдання додає мітки до цих Podʼів та відстежує зміни
у будь-яких Podʼах у кластері з такою ж міткою.

Контролер Завдання також додає *посилання на власника* до цих Podʼів, посилаючись на Завдання, яке створило Podʼи. Якщо ви видаляєте Завдання, поки ці Podʼи працюють, Kubernetes використовує посилання на власника (а не мітки), щоб визначити, які Podʼи в кластері потрібно прибрати.

Kubernetes також обробляє завершувачі, коли визначає посилання на власника ресурсу, призначене для видалення.

У деяких ситуаціях завершувачі можуть блокувати видалення залежних обʼєктів, що може призвести до того, що цільовий обʼєкт-власник залишиться довше, ніж очікувалося, не буде повністю видалений. У таких ситуаціях вам слід перевірити завершувачі та посилання на власника, на цільового власника та залежні
обʼєкти для усунення несправностей.

{{<note>}}
У випадках, коли обʼєкти застрягають в стані видалення, уникайте ручного видалення завершувачів для продовження процесу видалення. Завершувачі, як правило, додаються до ресурсів з певною метою, тому примусове їх видалення може призвести до проблем у вашому кластері. Це слід робити лише тоді, коли призначення завершувача зрозуміло та може бути виконано іншим способом (наприклад, ручне очищення деякого залежного обʼєкта).
{{</note>}}

## {{% heading "whatsnext" %}}

* Прочитайте [Using Finalizers to Control Deletion](/blog/2021/05/14/using-finalizers-to-control-deletion/) в блозі Kubernetes.
