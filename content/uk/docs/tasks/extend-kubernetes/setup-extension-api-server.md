---
title: Налаштування API сервера розширення
content_type: task
weight: 15
---

<!-- overview -->

Налаштування API сервера розширення для роботи з шаром агрегації дозволяє розширювати apiserver Kubernetes додатковими API, які не є частиною основних API Kubernetes.

## {{% heading "prerequisites" %}}

{{< include "task-tutorial-prereqs.md" >}} {{< version-check >}}

* Необхідно [налаштувати шар агрегації](/docs/tasks/extend-kubernetes/configure-aggregation-layer/) та увімкнути прапорці apiserver.

<!-- steps -->

## Налаштування API сервера розширення для роботи з шаром агрегації

Наступні кроки описують налаштування apiserverʼа розширення *на високому рівні*. Ці кроки застосовуються незалежно від того, чи використовуєте ви YAML конфігурації, чи API. Робиться спроба конкретно визначити будь-які відмінності між цими двома підходами. Для конкретного прикладу їх реалізації за допомогою YAML конфігурацій, ви можете ознайомитися з [sample-apiserver](https://github.com/kubernetes/sample-apiserver/blob/master/README.md) у репозиторії Kubernetes.

Альтернативно, ви можете використовувати наявне стороннє рішення, таке як [apiserver-builder](https://github.com/kubernetes-sigs/apiserver-builder-alpha/blob/master/README.md), яке має згенерувати кістяк та автоматизувати всі наступні кроки для вас.

1. Переконайтеся, що APIService API увімкнено (перевірте `--runtime-config`). Воно має бути типово увімкнене, якщо воно не було свідомо вимкнено у вашому кластері.
2. Можливо, вам потрібно створити правило RBAC, яке дозволяє додавати обʼєкти APIService, або попросити адміністратора вашого кластера створити його. (Оскільки розширення API впливають на весь кластер, не рекомендується проводити тестування/розробку/налагодження розширення API у робочому кластері.)
3. Створіть простір імен Kubernetes, у якому ви хочете запустити свій api-сервер розширення.
4. Отримайте сертифікат CA, який буде використовуватися для підпису сертифіката сервера, що використовує api-сервер розширення для HTTPS.
5. Створіть серверний сертифікат/ключ для api-сервера, який буде використовуватися для HTTPS. Цей сертифікат повинен бути підписаний вище згаданим CA. Він також повинен мати CN у вигляді імені Kube DNS. Це імʼя формується на основі сервісу Kubernetes і має вигляд `<service name>.<service name namespace>.svc`.
6. Створіть Secret Kubernetes з серверним сертифікатом/ключем у вашому просторі імен.
7. Створіть Deployment Kubernetes для api-сервера розширення і переконайтеся, що ви завантажуєте Secret як том. Він повинен містити посилання на робочий образ вашого api-сервера розширення. Deployment також повинен бути у вашому просторі імен.
8. Переконайтеся, що ваш api-сервер розширення завантажує ці сертифікати з того тому і що вони використовуються в процесі рукостискання (handshake) HTTPS.
9. Створіть службовий обліковий запис (service account) Kubernetes у вашому просторі імен.
10. Створіть кластерну роль Kubernetes для операцій, які ви хочете дозволити над вашими ресурсами.
11. Створіть привʼязку кластерної ролі до службового облікового запису (service account) у вашому просторі імен до створеної кластерної ролі.
12. Створіть привʼязку кластерної ролі до службового облікового запису (service account) у вашому просторі імен до кластерної ролі `system:auth-delegator` для делегування рішень щодо автентифікації на основному API серверу Kubernetes.
13. Створіть привʼязку службового облікового запису (service account) у вашому просторі імен до ролі `extension-apiserver-authentication-reader`. Це дозволяє вашому api-серверу розширення отримувати доступ до ConfigMap `extension-apiserver-authentication`.
14. Створіть apiservice Kubernetes. CA сертифікат повинен бути закодований в base64, не містити позбавлений нових рядків і використаний як spec.caBundle в apiservice. Він не повинен бути привʼязаний до простору імен. Якщо ви використовуєте [kube-aggregator API](https://github.com/kubernetes/kube-aggregator/), передайте лише PEM-кодований CA bundle, оскільки кодування в base64 виконується за вас.
15. Використовуйте kubectl для отримання вашого ресурсу. Під час запуску kubectl повинен повернути "No resources found.". Це повідомлення вказує на те, що все спрацювало, але наразі у вас немає створених обʼєктів цього типу ресурсу.

## {{% heading "whatsnext" %}}

* Пройдіть кроки, щоб [налаштувати шар агрегації API](/docs/tasks/extend-kubernetes/configure-aggregation-layer/) та увімкнути прапорці apiserver.
* Для загального огляду дивіться [Розширення API Kubernetes за допомогою шару агрегації](/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/).
* Дізнайтеся, як [Розширити API Kubernetes за допомогою Custom Resource Definitions](/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/).
