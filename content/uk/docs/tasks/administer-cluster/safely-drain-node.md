---
title: Безпечне очищення вузла
content_type: task
weight: 310
---

<!-- overview -->

Ця сторінка показує, як безпечно очистити {{< glossary_tooltip text="вузол" term_id="node" >}}, опційно дотримуючись PodDisruptionBudget, який ви визначили.

## {{% heading "prerequisites" %}}

Це завдання передбачає, що ви виконали такі попередні умови:

1. Вам не потрібно, щоб ваші застосунки були високодоступними під час очищення вузла, або
2. Ви прочитали про концепцію [PodDisruptionBudget](/docs/concepts/workloads/pods/disruptions/) та [налаштували PodDisruptionBudget](/docs/tasks/run-application/configure-pdb/) для застосунків, які їх потребують.

## (Необовʼязково) Налаштування бюджету відмови {#configure-poddisruptionbudget}

Щоб забезпечити доступність ваших робочих навантажень під час технічного обслуговування, ви можете налаштувати [PodDisruptionBudget](/docs/concepts/workloads/pods/disruptions/).

Якщо доступність важлива для будь-яких застосунків, які запускаються або можуть запускатися на вузлах, які ви очищуєте, [спочатку налаштуйте PodDisruptionBudget](/docs/tasks/run-application/configure-pdb/), а потім продовжуйте виконувати цей посібник.

Рекомендується встановити `AlwaysAllow` [Політика виселення несправного Podʼа](/docs/tasks/run-application/configure-pdb/#unhealthy-pod-eviction-policy) для PodDisruptionBudgets, щоб підтримувати виселення погано працюючих застосунків під час очищення вузла. Стандартна поведінка полягає в очікуванні на те, щоб Podʼи застосунків стали [справними](/docs/tasks/run-application/configure-pdb/#healthiness-of-a-pod), перш ніж можна буде продовжити очищення.

## Використання `kubectl drain` для очищення вузла {#use-kubectl-drain-to-remove-a-node-from-service}

Ви можете використовувати `kubectl drain` для безпечного виселення всіх ваших Podʼів з вузла перед тим, як ви будете виконувати обслуговування вузла (наприклад, оновлення ядра, обслуговування обладнання тощо). Безпечні виселення дозволяють контейнерам Podʼів [належним чином завершувати роботу](/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination) і дотримуватись PodDisruptionBudgets, які ви визначили.

{{< note >}}
Типово `kubectl drain` ігнорує певні системні Podʼи на вузлі, роботу яких не можна завершити примусово; докладніше див. документацію [kubectl drain](/docs/reference/generated/kubectl/kubectl-commands/#drain).
{{< /note >}}

Коли `kubectl drain` успішно завершується, це означає, що всі Podʼи (крім тих, які виключені, як описано в попередньому абзаці) безпечно виселені (дотримуючись бажаного періоду належного завершення роботи та PodDisruptionBudget, який ви визначили). Тоді безпечно вимкніть вузол, вимкнувши його фізичний компʼютер або, якщо ви працюєте на хмарній платформі, видаливши його віртуальну машину.

{{< note >}}
Якщо нові Podʼи толерують taint `node.kubernetes.io/unschedulable`, то ці Podʼи можуть бути заплановані на вузол, який ви очистили. Уникайте толерування цього taint, крім як для DaemonSets.

Якщо ви або інший користувач API безпосередньо встановили поле [`nodeName`](/docs/concepts/scheduling-eviction/assign-pod-node/#nodename) для Podʼа (в обхід планувальника), то Pod буде привʼязаний до вказаного вузла і буде працювати там, навіть якщо ви його очистили та позначили як не придатний для планування.
{{< /note >}}

Спочатку визначте імʼя вузла, який ви хочете очистити. Ви можете перелічити всі вузли у своєму кластері за допомогою

```shell
kubectl get nodes
```

Далі скажіть Kubernetes очистити вузол:

```shell
kubectl drain --ignore-daemonsets <імʼя вузла>
```

Якщо є Podʼи, керовані DaemonSet, вам потрібно вказати `--ignore-daemonsets` в `kubectl`, щоб успішно очистити вузол. Підкоманда `kubectl drain` сама по собі насправді не очищує вузол від його Podʼів DaemonSet: контролер DaemonSet (частина контролера управління) негайно замінює відсутні Podʼи новими еквівалентними Podʼами. Контролер DaemonSet також створює Podʼи, які ігнорують taint, що перешкоджають плануванню, що дозволяє новим Podʼам запуститися на вузлі, який ви очистили.

Після того, як процес завершиться (без помилки), ви можете безпечно вимкнути вузол (або еквівалентно, якщо ви працюєте на хмарній платформі, видалити віртуальну машину, на якій працює вузол). Якщо ви залишите вузол у кластері під час операції обслуговування, вам потрібно виконати

```shell
kubectl uncordon <імʼя вузла>
```

після того, як ви дасте цю команду Kubernetes, він може продовжити планування нових Podʼів на вузол.

## Очищення кількох вузлів паралельно {#draining-multiple-nodes-in-parallel}

Команду `kubectl drain` слід використовувати тільки для одного вузла за раз. Однак ви можете запускати кілька команд `kubectl drain` для різних вузлів паралельно, в різних терміналах або у фоні. Декілька команд очищення, які працюють паралельно, все одно дотримуються PodDisruptionBudget, який ви вказуєте.

Наприклад, якщо у вас є StatefulSet із трьома репліками та ви встановили PodDisruptionBudget для цього набору, вказуючи `minAvailable: 2`, `kubectl drain` видаляє тільки Pod з StatefulSet, якщо всі три репліки Pod є [справними](/docs/tasks/run-application/configure-pdb/#healthiness-of-a-pod); якщо дати декілька команд паралельно, Kubernetes дотримується PodDisruptionBudget та забезпечує, що в будь-який момент часу лише один (обчислюється як `replicas - minAvailable`) Pod недоступний. Будь-які очищення, які призведуть до того, що кількість [справних](/docs/tasks/run-application/configure-pdb/#healthiness-of-a-pod) реплік падає нижче визначеного бюджету, блокуються.

## API Eviction {#eviction-api}

Якщо ви не бажаєте використовувати [kubectl drain](/docs/reference/generated/kubectl/kubectl-commands/#drain) (наприклад, для уникнення виклику зовнішньої команди або для отримання більш детального керування процесом виселення Podʼа), ви також можете програмно викликати виселення, використовуючи API Eviction.

Для отримання додаткової інформації див. [Виселення, ініційоване API](/docs/concepts/scheduling-eviction/api-eviction/).

## {{% heading "whatsnext" %}}

* Дотримуйтеся кроків для захисту вашого застосунку, налаштувавши [Обмеження переривання роботи Podʼів](/docs/tasks/run-application/configure-pdb/).
