---
title: Використання sysctl в кластері Kubernetes
content_type: task
weight: 400
---

<!-- overview -->

{{< feature-state for_k8s_version="v1.21" state="stable" >}}

У цьому документі описано, як налаштовувати та використовувати параметри ядра в межах кластера Kubernetes, використовуючи інтерфейс {{< glossary_tooltip term_id="sysctl" >}}.

{{< note >}}
Починаючи з версії Kubernetes 1.23, kubelet підтримує використання `/` або `.` як роздільники для назв sysctl. Починаючи з версії Kubernetes 1.25, налаштування Sysctls для контейнера підтримує встановлення sysctl зі слешами. Наприклад, ви можете представити ту саму назву sysctl як `kernel.shm_rmid_forced`, використовуючи крапку як роздільник, або як `kernel/shm_rmid_forced`, використовуючи слеш як роздільник. Для отримання додаткових відомостей щодо методу конвертації параметра sysctl див. сторінку [sysctl.d(5)](https://man7.org/linux/man-pages/man5/sysctl.d.5.html) проєкту Linux man-pages.
{{< /note >}}

## {{% heading "prerequisites" %}}

{{< note >}}
`sysctl` — це інструмент командного рядка, специфічний для Linux, який використовується для налаштування різних параметрів ядра, і він недоступний в операційних системах, що не базуються на Linux.
{{< /note >}}

{{< include "task-tutorial-prereqs.md" >}}

Для деяких кроків вам також потрібно мати змогу змінювати параметри командного рядка для kubelet, що працюють на вашому кластері.

<!-- steps -->

## Перелік всіх параметрів Sysctl {#listing-all-sysctl-parameters}

У Linux інтерфейс sysctl дозволяє адміністратору змінювати параметри ядра під час виконання. Параметри доступні через віртуальну файлову систему `/proc/sys/`. Параметри охоплюють різні підсистеми, такі як:

- ядро (загальний префікс: `kernel.`)
- мережа (загальний префікс: `net.`)
- віртуальна памʼять (загальний префікс: `vm.`)
- MDADM (загальний префікс: `dev.`)
- Більше підсистем описано у [документації ядра](https://www.kernel.org/doc/Documentation/sysctl/README).

Щоб отримати список всіх параметрів, ви можете виконати команду:

```shell
sudo sysctl -a
```

## Безпечні та Небезпечні Sysctl {#safe-and-unsafe-sysctls}

Kubernetes класифікує sysctl як _безпечні_ або _небезпечні_. Крім належного просторового розмежування, _безпечний_ sysctl повинен бути належним чином _ізольованим_ між Podʼами на тому ж вузлі. Це означає, що встановлення _безпечного_ sysctl для одного Podʼа

- не повинно мати жодного впливу на інші Podʼи на вузлі
- не повинно дозволяти шкодити справності вузла
- не повинно дозволяти отримувати CPU або ресурси памʼяті поза межами обмежень ресурсів Podʼа.

Наразі більшість _просторово розмежованих_ (по просторах імен) sysctl не обовʼязково вважаються _безпечними_. До набору _безпечних_ sysctl входять наступні параметри:

- `kernel.shm_rmid_forced`;
- `net.ipv4.ip_local_port_range`;
- `net.ipv4.tcp_syncookies`;
- `net.ipv4.ping_group_range` (починаючи з Kubernetes 1.18);
- `net.ipv4.ip_unprivileged_port_start` (починаючи з Kubernetes 1.22);
- `net.ipv4.ip_local_reserved_ports` (починаючи з Kubernetes 1.27, потрібне ядро 3.16+);
- `net.ipv4.tcp_keepalive_time` (починаючи з Kubernetes 1.29, потрібне ядро 4.5+);
- `net.ipv4.tcp_fin_timeout` (починаючи з Kubernetes 1.29, потрібне ядро 4.6+);
- `net.ipv4.tcp_keepalive_intvl` (починаючи з Kubernetes 1.29, потрібне ядро 4.5+);
- `net.ipv4.tcp_keepalive_probes` (починаючи з Kubernetes 1.29, потрібне ядро 4.5+).
- `net.ipv4.tcp_rmem` (починаючи Kubernetes 1.32, потрібне ядро 4.15+).
- `net.ipv4.tcp_wmem` (починаючи Kubernetes 1.32, потрібне ядро 4.15+).

{{< note >}}
Є деякі винятки зі списку безпечних sysctl:

- Параметри sysctl `net.*` не дозволені з увімкненою мережею вузла.
- Параметр sysctl `net.ipv4.tcp_syncookies` не має просторового розмежування в ядрах Linux версії 4.5 або нижче.
{{< /note >}}

Цей список буде розширюватися у майбутніх версіях Kubernetes, коли kubelet буде підтримувати кращі механізми ізоляції.

### Увімкнення небезпечних Sysctl {#enabling-unsafe-sysctls}

Всі _безпечні_ sysctl є типово увімкненими.

Всі _небезпечні_ sysctl типово вимкнені та повинні бути дозволені вручну адміністратором кластера на кожному вузлі окремо. Podʼи з вимкненими небезпечними sysctl будуть заплановані, але їх не вдасться запустити.

З врахуванням попередження вище, адміністратор кластера може дозволити певні _небезпечні_ sysctl для дуже спеціальних ситуацій, таких як налаштування високопродуктивних або застосунків реального часу. _Небезпечні_ sysctl вмикаються на основі вузла з прапорцем kubelet; наприклад:

```shell
kubelet --allowed-unsafe-sysctls \
  'kernel.msg*,net.core.somaxconn' ...
```

Для {{< glossary_tooltip term_id="minikube" >}}, це можна зробити за допомогою прапорця `extra-config`:

```shell
minikube start --extra-config="kubelet.allowed-unsafe-sysctls=kernel.msg*,net.core.somaxconn"...
```

Таким чином можна увімкнути лише _просторово розмежовані_ sysctl.

## Налаштування Sysctl для Podʼа {#setting-sysctls-for-a-pod}

Численні sysctl _просторово розмежовані_ в сучасних ядрах Linux. Це означає, що їх можна налаштовувати незалежно для кожного Pod на вузлі. Лише _просторово розмежовані_ sysctl можна налаштовувати через securityContext Podʼа в межах Kubernetes.

Відомо, що наступні sysctl мають просторове розмежування. Цей список може змінитися в майбутніх версіях ядра Linux.

- `kernel.shm*`
- `kernel.msg*`
- `kernel.sem`
- `fs.mqueue.*`
- Ті `net.*`, які можна налаштувати в просторі імен мережі контейнера. Однак є винятки (наприклад, `net.netfilter.nf_conntrack_max` та `net.netfilter.nf_conntrack_expect_max` можуть бути налаштовані в просторі імен мережі контейнера, але не мають просторового розмежування до Linux 5.12.2).

Sysctl без просторового розмежування називають _вузловими_ sysctl. Якщо вам потрібно налаштувати їх, ви повинні вручну налаштувати їх в операційній системі кожного вузла або за допомогою DaemonSet з привілейованими контейнерами.

Використовуйте securityContext Podʼа для налаштування просторово розмежованих sysctl. securityContext застосовується до всіх контейнерів у тому ж Podʼі.

У цьому прикладі використовується securityContext Podʼа для встановлення безпечного sysctl `kernel.shm_rmid_forced` та двох небезпечних sysctl `net.core.somaxconn` та `kernel.msgmax`. В специфікації немає розрізнення між _безпечними_ та _небезпечними_ sysctl.

{{< warning >}}
Змінюйте параметри sysctl лише після розуміння їхніх наслідків, щоб уникнути дестабілізації вашої операційної системи.
{{< /warning >}}

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: sysctl-example
spec:
  securityContext:
    sysctls:
    - name: kernel.shm_rmid_forced
      value: "0"
    - name: net.core.somaxconn
      value: "1024"
    - name: kernel.msgmax
      value: "65536"
  ...
```

<!-- discussion -->

{{< warning >}}
Через їхню природу бути _небезпечними_, використання _небезпечних_ sysctl здійснюється на ваш власний ризик і може призвести до серйозних проблем, таких як неправильна поведінка контейнерів, нестача ресурсів або повний розлад вузла.
{{< /warning >}}

Хорошою практикою є вважати вузли з особливими налаштуваннями sysctl як позначені _taint_ в межах кластера і планувати на них лише ті Podʼи, яким потрібні ці налаштування sysctl. Рекомендується використовувати функцію [_Заплямованість та Толерантність_ кластера Kubernetes](/docs/reference/generated/kubectl/kubectl-commands/#taint), щоб реалізувати це.

Pod з _небезпечними_ sysctl не вдасться запустити на будь-якому вузлі, на якому не були явно увімкнені ці два _небезпечні_ sysctl. Як і з _вузловими_ sysctl, рекомендується використовувати [функцію _Заплямованість та Толерантність_](/docs/reference/generated/kubectl/kubectl-commands/#taint) або
[заплямованість вузлів](/docs/concepts/scheduling-eviction/taint-and-toleration/) для планування цих Podʼів на відповідні вузли.
