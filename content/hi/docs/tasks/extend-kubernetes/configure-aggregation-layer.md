---
title: एग्रीगेशन लेयर कॉन्फ़िगर करें
reviewers:
- lavalamp
- cheftako
- chenopis
content_type: task
weight: 10
---

<!-- overview -->

[एग्रीगेशन लेयर](/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/) को कॉन्फ़िगर करने से कुबेरनेट्स apiserver को अतिरिक्त APIs के साथ विस्तारित किया जा सकता है, जो कोर कुबेरनेट्स APIs का हिस्सा नहीं हैं।

## {{% heading "prerequisites" %}}

{{< include "task-tutorial-prereqs.md" >}} {{< version-check >}}

{{< note >}}
प्रॉक्सी और एक्सटेंशन एपीसर्वर के बीच म्यूचुअल TLS ऑथेंटिकेशन को सपोर्ट करने के लिए आपके एनवायरनमेंट में एग्रीगेशन लेयर को कार्यशील बनाने के लिए कुछ सेटअप आवश्यकताएं हैं।
कुबेरनेट्स और kube-apiserver के कई CAs हैं, इसलिए सुनिश्चित करें कि प्रॉक्सी एग्रीगेशन लेयर CA द्वारा साइन किया गया है और किसी अन्य द्वारा नहीं, जैसे कुबेरनेट्स जनरल CA।
{{< /note >}}

{{< caution >}}
विभिन्न क्लाइंट प्रकारों के लिए एक ही CA का पुन: उपयोग करने से क्लस्टर की कार्यक्षमता पर नकारात्मक प्रभाव पड़ सकता है। अधिक जानकारी के लिए, [CA पुनर्प्रयोग और विरोध](#ca-reusage-and-conflicts) देखें।
{{< /caution >}}

<!-- steps -->

## प्रमाणीकरण प्रवाह {#authentication-flow}

कस्टम रिसोर्स डेफिनिशन (CRDs) के विपरीत, एग्रीगेशन API में मानक कुबेरनेट्स apiserver के अतिरिक्त एक अन्य सर्वर - आपका एक्सटेंशन apiserver - शामिल है।
कुबेरनेट्स apiserver को आपके एक्सटेंशन apiserver के साथ संवाद करने की आवश्यकता होगी,
और आपके एक्सटेंशन apiserver को कुबेरनेट्स apiserver के साथ संवाद करने की आवश्यकता होगी।
इस संचार को सुरक्षित करने के लिए, कुबेरनेट्स apiserver x509 सर्टिफिकेट का उपयोग करता है
ताकि यह स्वयं को एक्सटेंशन apiserver के लिए प्रमाणित कर सके।

यह खंड बताता है कि प्रमाणीकरण और प्राधिकरण प्रवाह कैसे काम करते हैं,
और उन्हें कैसे कॉन्फ़िगर किया जाए।

उच्च-स्तरीय प्रवाह इस प्रकार है:

1. कुबेरनेट्स apiserver: अनुरोध करने वाले उपयोगकर्ता को प्रमाणित करें और अनुरोधित API पथ के लिए उनके अधिकारों को प्राधिकृत करें।
2. कुबेरनेट्स apiserver: अनुरोध को एक्सटेंशन apiserver पर प्रॉक्सी करें
3. एक्सटेंशन apiserver: कुबेरनेट्स apiserver से अनुरोध को प्रमाणित करें
4. एक्सटेंशन apiserver: मूल उपयोगकर्ता से अनुरोध को प्राधिकृत करें
5. एक्सटेंशन apiserver: निष्पादित करें

इस खंड का शेष भाग इन चरणों का विस्तार से वर्णन करता है।

प्रवाह को निम्नलिखित आरेख में देखा जा सकता है।

![एग्रीगेशन ऑथ फ्लो](/images/docs/aggregation-api-auth-flow.png)

### कुबेरनेट्स Apiserver प्रमाणीकरण और प्राधिकरण {#kubernetes-apiserver-authentication-and-authorization}

एक्सटेंशन apiserver द्वारा सेवित API पथ के लिए एक अनुरोध सभी API अनुरोधों की तरह शुरू होता है: कुबेरनेट्स apiserver के साथ संचार।
यह पथ पहले से ही एक्सटेंशन apiserver द्वारा कुबेरनेट्स apiserver के साथ पंजीकृत किया गया है।

उपयोगकर्ता कुबेरनेट्स apiserver के साथ संवाद करता है, पथ तक पहुंच का अनुरोध करता है।
कुबेरनेट्स apiserver मानक प्रमाणीकरण और प्राधिकरण का उपयोग करता है जो कुबेरनेट्स apiserver के साथ कॉन्फ़िगर किया गया है
ताकि उपयोगकर्ता को प्रमाणित किया जा सके और विशिष्ट पथ तक पहुंच को प्राधिकृत किया जा सके।

कुबेरनेट्स क्लस्टर में प्रमाणीकरण का अवलोकन के लिए,
["क्लस्टर में प्रमाणीकरण"](/docs/reference/access-authn-authz/authentication/) देखें।
कुबेरनेट्स क्लस्टर संसाधनों तक पहुंच के प्राधिकरण का अवलोकन के लिए,
["प्राधिकरण अवलोकन"](/docs/reference/access-authn-authz/authorization/) देखें।

इस बिंदु तक सब कुछ मानक कुबेरनेट्स API अनुरोध, प्रमाणीकरण और प्राधिकरण रहा है।

अब कुबेरनेट्स apiserver एक्सटेंशन apiserver को अनुरोध भेजने के लिए तैयार है।

### कुबेरनेट्स Apiserver अनुरोध को प्रॉक्सी करता है {#kubernetes-apiserver-proxies-the-request}

अब कुबेरनेट्स apiserver अनुरोध को एक्सटेंशन apiserver पर भेजेगा, या प्रॉक्सी करेगा, जो अनुरोध को हैंडल करने के लिए पंजीकृत है।
ऐसा करने के लिए, इसे कई चीजें जानने की आवश्यकता है:

1. कुबेरनेट्स apiserver को एक्सटेंशन apiserver के साथ कैसे प्रमाणित होना चाहिए,
   एक्सटेंशन apiserver को सूचित करते हुए कि अनुरोध, जो नेटवर्क पर आता है,
   एक वैध कुबेरनेट्स apiserver से आ रहा है?
2. कुबेरनेट्स apiserver को एक्सटेंशन apiserver को कैसे सूचित करना चाहिए
   उस उपयोगकर्ता नाम और समूह के बारे में जिसके लिए मूल अनुरोध प्रमाणित किया गया था?

इन दोनों के लिए प्रावधान करने के लिए, आपको कई फ्लैग का उपयोग करके कुबेरनेट्स apiserver को कॉन्फ़िगर करना होगा।

#### कुबेरनेट्स Apiserver क्लाइंट प्रमाणीकरण {#kubernetes-apiserver-client-authentication}

कुबेरनेट्स apiserver TLS के माध्यम से एक्सटेंशन apiserver से कनेक्ट होता है,
एक क्लाइंट सर्टिफिकेट का उपयोग करके स्वयं को प्रमाणित करता है। आपको स्टार्टअप पर
प्रदान किए गए फ्लैग का उपयोग करके कुबेरनेट्स apiserver को निम्नलिखित प्रदान करना होगा:

* प्राइवेट की फ़ाइल `--proxy-client-key-file` के माध्यम से
* साइन किया गया क्लाइंट सर्टिफिकेट फ़ाइल `--proxy-client-cert-file` के माध्यम से
* क्लाइंट सर्टिफिकेट फ़ाइल को साइन करने वाले CA का सर्टिफिकेट `--requestheader-client-ca-file` के माध्यम से
* साइन किए गए क्लाइंट सर्टिफिकेट में वैध कॉमन नेम वैल्यू (CNs) `--requestheader-allowed-names` के माध्यम से

कुबेरनेट्स apiserver `--proxy-client-*-file` द्वारा इंगित फ़ाइलों का उपयोग करेगा
एक्सटेंशन apiserver के साथ प्रमाणित होने के लिए। अनुरोध को एक अनुपालन एक्सटेंशन apiserver द्वारा
वैध माना जाने के लिए, निम्नलिखित शर्तें पूरी होनी चाहिए:

1. कनेक्शन एक क्लाइंट सर्टिफिकेट का उपयोग करके किया जाना चाहिए जो उस CA द्वारा साइन किया गया हो
   जिसका सर्टिफिकेट `--requestheader-client-ca-file` में है।
2. कनेक्शन एक क्लाइंट सर्टिफिकेट का उपयोग करके किया जाना चाहिए जिसका CN उनमें से एक है
   जो `--requestheader-allowed-names` में सूचीबद्ध हैं।

{{< note >}}
आप इस विकल्प को `--requestheader-allowed-names=""` के रूप में खाली सेट कर सकते हैं।
यह एक्सटेंशन apiserver को इंगित करेगा कि _कोई भी_ CN स्वीकार्य है।
{{< /note >}}

इन विकल्पों के साथ शुरू किए जाने पर, कुबेरनेट्स apiserver:

1. उनका उपयोग एक्सटेंशन apiserver के साथ प्रमाणित होने के लिए करेगा।
2. `kube-system` नेमस्पेस में `extension-apiserver-authentication` नामक एक कॉन्फ़िगमैप बनाएगा,
   जिसमें यह CA सर्टिफिकेट और अनुमत CNs को रखेगा। इन्हें बदले में एक्सटेंशन apiserver
   द्वारा अनुरोधों को मान्य करने के लिए पुनर्प्राप्त किया जा सकता है।

ध्यान दें कि एक ही क्लाइंट सर्टिफिकेट का उपयोग कुबेरनेट्स apiserver द्वारा _सभी_ एक्सटेंशन apiserver
के विरुद्ध प्रमाणित होने के लिए किया जाता है। यह प्रति एक्सटेंशन apiserver एक क्लाइंट सर्टिफिकेट नहीं बनाता है,
बल्कि कुबेरनेट्स apiserver के रूप में प्रमाणित होने के लिए एक ही सर्टिफिकेट का उपयोग करता है।
यही एक सभी एक्सटेंशन apiserver अनुरोधों के लिए पुन: उपयोग किया जाता है।

#### मूल अनुरोध उपयोगकर्ता नाम और समूह {#original-request-username-and-group}

जब कुबेरनेट्स apiserver अनुरोध को एक्सटेंशन apiserver पर प्रॉक्सी करता है,
यह एक्सटेंशन apiserver को उस उपयोगकर्ता नाम और समूह के बारे में सूचित करता है जिसके साथ मूल अनुरोध
सफलतापूर्वक प्रमाणित हुआ था। यह इन्हें अपने प्रॉक्सी किए गए अनुरोध के http हेडर में प्रदान करता है।
आपको कुबेरनेट्स apiserver को उपयोग किए जाने वाले हेडर के नामों के बारे में बताना होगा।

* उपयोगकर्ता नाम को स्टोर करने के लिए हेडर `--requestheader-username-headers` के माध्यम से
* समूह को स्टोर करने के लिए हेडर `--requestheader-group-headers` के माध्यम से
* सभी अतिरिक्त हेडर में जोड़े जाने वाले प्रीफ़िक्स `--requestheader-extra-headers-prefix` के माध्यम से

ये हेडर नाम भी `extension-apiserver-authentication` कॉन्फ़िगमैप में रखे जाते हैं,
ताकि एक्सटेंशन apiserver द्वारा उन्हें पुनर्प्राप्त और उपयोग किया जा सके।

### CA पुनर्प्रयोग और विरोध {#ca-reusage-and-conflicts}

कुबेरनेट्स apiserver के दो क्लाइंट CA विकल्प हैं:

* `--client-ca-file`
* `--requestheader-client-ca-file`

इनमें से प्रत्येक स्वतंत्र रूप से कार्य करता है और एक दूसरे के साथ विरोध कर सकता है, यदि सही ढंग से उपयोग नहीं किया जाए।

* `--client-ca-file`: जब कुबेरनेट्स apiserver पर एक अनुरोध आता है, यदि यह विकल्प सक्षम है, तो कुबेरनेट्स apiserver अनुरोध के सर्टिफिकेट की जांच करता है। यदि यह `--client-ca-file` द्वारा संदर्भित फ़ाइल में CA सर्टिफिकेट में से एक द्वारा साइन किया गया है, तो अनुरोध को वैध माना जाता है, और उपयोगकर्ता कॉमन नेम `CN=` का मान है, जबकि समूह संगठन `O=` है।

* `--requestheader-client-ca-file`: जब कुबेरनेट्स apiserver पर एक अनुरोध आता है, यदि यह विकल्प सक्षम है, तो कुबेरनेट्स apiserver अनुरोध के सर्टिफिकेट की जांच करता है। यदि यह `--requestheader-client-ca-file` द्वारा संदर्भित फ़ाइल में CA सर्टिफिकेट में से एक द्वारा साइन किया गया है, तो अनुरोध को संभावित रूप से वैध माना जाता है। फिर कुबेरनेट्स apiserver जांचता है कि क्या कॉमन नेम `CN=` `--requestheader-allowed-names` द्वारा प्रदान की गई सूची में से एक है। यदि नाम अनुमत है, तो अनुरोध स्वीकृत हो जाता है; यदि नहीं, तो अनुरोध अस्वीकृत हो जाता है।

यदि _दोनों_ `--client-ca-file` और `--requestheader-client-ca-file` प्रदान किए जाते हैं, तो अनुरोध पहले `--requestheader-client-ca-file` CA की जांच करता है और फिर `--client-ca-file` की। सामान्यतः, इन विकल्पों में से प्रत्येक के लिए अलग-अलग CA का उपयोग किया जाता है, या तो रूट CA या इंटरमीडिएट CA; नियमित क्लाइंट अनुरोध `--client-ca-file` से मेल खाते हैं, जबकि एग्रीगेशन अनुरोध `--requestheader-client-ca-file` से मेल खाते हैं।

{{< warning >}}
किसी भिन्न संदर्भ में उपयोग किए जाने वाले CA का पुन: उपयोग न करें जब तक कि आप जोखिमों और CA के उपयोग की सुरक्षा के तंत्र को न समझें।
{{< /warning >}}

यदि आप API सर्वर चलाने वाले होस्ट पर kube-proxy नहीं चला रहे हैं, तो आपको यह सुनिश्चित करना होगा कि सिस्टम निम्नलिखित `kube-apiserver` फ्लैग के साथ सक्षम है:

```
--enable-aggregator-routing=true
```

### APIService ऑब्जेक्ट्स पंजीकृत करें

आप गतिशील रूप से कॉन्फ़िगर कर सकते हैं कि कौन से क्लाइंट अनुरोध एक्सटेंशन apiserver पर प्रॉक्सी किए जाएं। निम्नलिखित एक उदाहरण पंजीकरण है:

```yaml
apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
  name: <पंजीकरण ऑब्जेक्ट का नाम>
spec:
  group: <यह एक्सटेंशन apiserver जिस API समूह को होस्ट करता है>
  version: <यह एक्सटेंशन apiserver जिस API संस्करण को होस्ट करता है>
  groupPriorityMinimum: <इस समूह के लिए इस APIService की प्राथमिकता, API दस्तावेज़ीकरण देखें>
  versionPriority: <एक समूह के भीतर इस संस्करण की क्रमबद्धता को प्राथमिकता देता है, API दस्तावेज़ीकरण देखें>
  service:
    namespace: <एक्सटेंशन apiserver सेवा का नेमस्पेस>
    name: <एक्सटेंशन apiserver सेवा का नाम>
  caBundle: <pem एनकोडेड ca cert जो सर्वर सर्ट को साइन करता है जिसका उपयोग वेबहुक द्वारा किया जाता है>
```

एक APIService ऑब्जेक्ट का नाम एक वैध पथ सेगमेंट नाम होना चाहिए।

## आगे क्या है

* एग्रीगेशन लेयर के साथ काम करने के लिए एक [एक्सटेंशन api-server सेट करें](/docs/tasks/extend-kubernetes/setup-extension-api-server/)।
* एक उच्च स्तरीय अवलोकन के लिए, [एग्रीगेशन लेयर के साथ कुबेरनेट्स API का विस्तार](/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/) देखें।
* जानें कि कैसे [कस्टम रिसोर्स डेफिनिशन का उपयोग करके कुबेरनेट्स API का विस्तार करें](/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/)। 