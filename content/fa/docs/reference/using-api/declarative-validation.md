---
title: Declarative API Validation
reviewers:
- aaron-prindle
- yongruilin
- jpbetz
- thockin
content_type: concept
weight: 20
---

{{< feature-state for_k8s_version="v1.33" state="beta" >}}

{{< skew currentVersion >}} شامل اعتبارسنجی اختیاری _declarative_ برای APIها است. وقتی این فعال باشد، سرور API Kubernetes می‌تواند از این مکانیسم به جای رویکرد قدیمی که به کدهای دست‌نویس Go (فایل‌های `validation.go`) متکی است، برای اطمینان از معتبر بودن درخواست‌های ارسالی به API استفاده کند.

توسعه‌دهندگان Kubernetes و افرادی که API Kubernetes را گسترش می‌دهند (/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/)، می‌توانند قوانین اعتبارسنجی را مستقیماً در کنار تعاریف نوع API (فایل‌های `types.go`) تعریف کنند. نویسندگان کد، برچسب‌های کامنت ویژه (مثلاً `+k8s:minimum=0`) را تعریف می‌کنند. سپس یک تولیدکننده کد (`validation-gen`) از این برچسب‌ها برای تولید کد Go بهینه شده برای اعتبارسنجی API استفاده می‌کند.


اگرچه این ویژگی در درجه اول بر مشارکت‌کنندگان Kubernetes و توسعه‌دهندگان بالقوه [extension API servers](/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/) تأثیر می‌گذارد، مدیران کلاستر باید رفتار آن را، به‌ویژه در مراحل راه‌اندازی، درک کنند.



اعتبارسنجی اعلانی به تدریج در حال ارائه است.
در Kubernetes {{< skew currentVersion >}}، رابط‌های برنامه‌نویسی کاربردی (API) که از اعتبارسنجی اعلانی استفاده می‌کنند عبارتند از:

* [ReplicationController](/docs/concepts/workloads/controllers/replicationcontroller/)

{{< note >}}
برای نسخه بتای این ویژگی، کوبرنتیز عمداً از یک API جایگزین به عنوان بستر آزمایشی برای این تغییر استفاده می‌کند.
نسخه‌های آینده کوبرنتیز ممکن است این ویژگی را به APIهای بیشتری گسترش دهند.
{{< /note >}}


*   `DeclarativeValidation`: (نسخه بتا، پیش‌فرض: `true`) وقتی فعال باشد، سرور API *هم* اعتبارسنجی اعلانی جدید و هم اعتبارسنجی دست‌نویس قدیمی را برای انواع/فیلدهای منتقل‌شده اجرا می‌کند. نتایج به‌صورت داخلی مقایسه می‌شوند.
*   `DeclarativeValidationTakeover`: (بتا، پیش‌فرض: `false`) این گیت تعیین می‌کند که کدام نتیجه اعتبارسنجی *معتبر* است (یعنی به کاربر برگردانده شده و برای تصمیمات پذیرش استفاده می‌شود).

**رفتار پیش‌فرض (Kubernetes {{< skew currentVersion >}}):

*  با مقادیر `DeclarativeValidation=true` و `DeclarativeValidationTakeover=false` (مقادیر پیش‌فرض برای گیت‌ها)، هر دو سیستم اعتبارسنجی اجرا می‌شوند.
*   **نتایج اعتبارسنجی *دست‌نویس* استفاده می‌شوند.** اعتبارسنجی اعلانی برای مقایسه در حالت عدم تطابق اجرا می‌شود.
*  عدم تطابق بین دو سیستم اعتبارسنجی توسط سرور API ثبت می‌شود و معیار `declarative_validation_mismatch_total` را افزایش می‌دهد. این به توسعه‌دهندگان کمک می‌کند تا اختلافات را در طول مرحله بتا شناسایی و برطرف کنند
*   **ارتقای کلاستر باید در مورد این ویژگی ایمن باشد**، زیرا منطق اعتبارسنجی معتبر به طور پیش‌فرض تغییر نمی‌کند.


مدیران سیستم می‌توانند به طور صریح `DeclarativeValidationTakeover=true` را فعال کنند تا اعتبارسنجی *declarative* برای فیلدهای منتقل شده معتبر شود، که معمولاً پس از تأیید پایداری در محیط آنها (مثلاً با نظارت بر معیار عدم تطابق) انجام می‌شود.

## غیرفعال کردن اعتبارسنجی اعلانی {#opt-out}

به عنوان یک مدیر کلاستر، می‌توانید غیرفعال کردن اعتبارسنجی اعلانی را در حالی که هنوز نسخه بتا است، تحت شرایط خاص در نظر بگیرید:

*   **Unexpected Validation Behavior:** اگر فعال کردن `DeclarativeValidationTakeover` منجر به خطاهای اعتبارسنجی غیرمنتظره شود یا به اشیایی که قبلاً نامعتبر بودند، اجازه اجرا دهد.
*   **Performance Regressions:** اگر نظارت افزایش قابل توجه تأخیر (مثلاً در `apiserver_request_duration_seconds`) را نشان دهد که با فعال‌سازی ویژگی مرتبط است.
*   **High Mismatch Rate:** اگر معیار `declarative_validation_mismatch_total` عدم تطابق‌های مکرری را نشان دهد، نشان‌دهنده‌ی اشکالات احتمالی در قوانین اعلانی است که بر حجم کاری کلاستر تأثیر می‌گذارند، حتی اگر `DeclarativeValidationTakeover` نادرست باشد.


برای بازگشت به حالت اعتبارسنجی دستی (همانطور که قبل از Kubernetes نسخه ۱.۳۳ استفاده می‌شد)، دروازه ویژگی `DeclarativeValidation` را غیرفعال کنید، برای مثال از طریق آرگومان‌های خط فرمان: (`--feature-gates=DeclarativeValidation=false`). این کار همچنین به طور ضمنی اثر `DeclarativeValidationTakeover` را غیرفعال می‌کند.

## ملاحظات مربوط به تنزل رتبه و بازگشت به نسخه قبلی

غیرفعال کردن این ویژگی به عنوان یک مکانیسم ایمنی عمل می‌کند. با این حال، از یک مورد حاشیه‌ای احتمالی (که به دلیل آزمایش‌های گسترده بعید به نظر می‌رسد) آگاه باشید: اگر یک اشکال در اعتبارسنجی اعلانی (هنگامی که `DeclarativeValidationTakeover=true`) *به اشتباه* اجازه داده باشد که یک شیء نامعتبر حفظ شود، غیرفعال کردن دروازه‌های ویژگی ممکن است باعث شود که به‌روزرسانی‌های بعدی آن شیء خاص توسط اعتبارسنجی دست‌نویس که اکنون معتبر (و صحیح) شده است، مسدود شود. حل این مشکل ممکن است نیاز به اصلاح دستی شیء ذخیره شده داشته باشد، که احتمالاً در موارد نادر از طریق اصلاح مستقیم etcd انجام می‌شود.


برای جزئیات بیشتر در مورد مدیریت دروازه‌های ویژگی، به [Feature Gates](/docs/reference/command-line-tools-reference/feature-gates/). مراجعه کنید.