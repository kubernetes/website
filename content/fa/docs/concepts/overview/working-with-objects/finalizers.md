---
title: نهایی کننده ها
content_type: concept
weight: 80
---

<!-- overview -->

{{<glossary_definition term_id="finalizer" length="long">}}

می‌توانید از **پایان‌دهنده‌ها** (finalizerها) برای کنترل {{<glossary_tooltip text="جمع‌آوری زباله" term_id="garbage-collection">}}  
اشیاء {{< glossary_tooltip text="objects" term_id="object" >}} استفاده کنید؛ به این ترتیب که به  
{{<glossary_tooltip text="کنترلرها" term_id="controller">}}‌ اطلاع می‌دهید پیش از حذف منبع هدف، وظایف پاک‌سازی مشخصی را انجام دهند.

پایان‌دهنده‌ها معمولاً کد اجرایی را مشخص نمی‌کنند؛ بلکه فهرستی از کلیدها روی یک منبع—مشابه حاشیه‌نویس‌ها—هستند.  
برخی پایان‌دهنده‌ها به‌طور خودکار توسط کوبرنتیز افزوده می‌شوند، اما می‌توانید پایان‌دهنده‌های خود را نیز تعریف کنید.

## نحوه کار پایان‌دهنده‌ها

هنگام ایجاد یک منبع با فایل مانیفست، می‌توانید پایان‌دهنده‌ها را در فیلد `metadata.finalizers` تعیین کنید.  
وقتی درخواست حذف منبع را می‌دهید، سرور API که این درخواست را پردازش می‌کند مقدارهای فیلد `finalizers` را می‌بیند و:

* شیء را طوری تغییر می‌دهد که فیلد `metadata.deletionTimestamp` با زمان آغاز حذف افزوده شود؛
* از حذف شیء جلوگیری می‌کند تا زمانی که تمام موارد از فیلد `metadata.finalizers` آن حذف شوند؛
* کد وضعیت `202` ‏(HTTP «Accepted») را برمی‌گرداند.

کنترلری که مسئول آن پایان‌دهنده است، به‌روزرسانی شیء و تنظیم فیلد `metadata.deletionTimestamp` را می‌بیند—علامتی که نشان می‌دهد حذف شیء درخواست شده است.  
کنترلر سپس می‌کوشد نیازهای پایان‌دهنده‌های مشخص‌شده برای آن منبع را برآورده کند. هر بار که شرط یک پایان‌دهنده برقرار شد، کنترلر آن کلید را از فیلد `finalizers` منبع برمی‌دارد.  
وقتی فیلد `finalizers` خالی شود، شیئی که فیلد `deletionTimestamp` برای آن تنظیم شده، به‌طور خودکار حذف می‌شود.  
همچنین می‌توانید از پایان‌دهنده‌ها برای جلوگیری از حذف منابعی استفاده کنید که تحت مدیریت نیستند.

یک نمونه رایج پایان‌دهنده، `kubernetes.io/pv-protection` است که از حذف تصادفی اشیای `PersistentVolume` جلوگیری می‌کند.  
وقتی یک شیء `PersistentVolume` توسط یک Pod استفاده می‌شود، کوبرنتیز پایان‌دهنده `pv-protection` را اضافه می‌کند.  
اگر بخواهید آن `PersistentVolume` را حذف کنید، شیء در وضعیت `Terminating` باقی می‌ماند، اما کنترلر نمی‌تواند آن را حذف کند چون پایان‌دهنده وجود دارد.  
وقتی Pod دیگر از `PersistentVolume` استفاده نکند، کوبرنتیز پایان‌دهنده `pv-protection` را پاک می‌کند و کنترلر حجم را حذف می‌کند.

{{<note>}}
* هنگام `DELETE` کردن یک شیء، کوبرنتیز زمان‌سنج حذف را برای آن شیء اضافه می‌کند و سپس بلافاصله شروع به محدود کردن تغییرات در فیلد `.metadata.finalizers` آن شیء می‌کند که اکنون در حالت انتظار حذف است. شما می‌توانید پایان‌دهنده‌های موجود را حذف کنید (حذف یک ورودی از فهرست `finalizers`)، اما نمی‌توانید پایان‌دهنده جدیدی اضافه کنید. همچنین نمی‌توانید پس از تنظیم، `deletionTimestamp` را تغییر دهید.

* پس از درخواست حذف، نمی‌توانید این شیء را باززنده کنید. تنها راه، حذف آن و ایجاد یک شیء مشابه جدید است.
{{</note>}}

{{<note>}}
نام‌های پایان‌دهنده سفارشی **باید** نام‌های پایان‌دهنده واجد شرایط عمومی باشند، مانند `example.com/finalizer-name`. کوبرنتیز این قالب را اجرا می‌کند؛ سرور API نوشتن روی اشیایی را که تغییر آن‌ها از نام‌های واجد شرایط پایان‌دهنده برای هر پایان‌دهنده سفارشی استفاده نمی‌کند، رد می‌کند.
{{</note>}}

## مراجع مالک، برچسب‌ها و پایان‌دهنده‌ها {#owners-labels-finalizers}

مانند {{<glossary_tooltip text="labels" term_id="label">}}  
[مراجع مالک](/docs/concepts/overview/working-with-objects/owners-dependents/)  
روابط بین اشیاء در کوبرنتیز را توصیف می‌کنند، اما برای هدف متفاوتی استفاده می‌شوند.  
هنگامی که یک {{<glossary_tooltip text="controller" term_id="controller">}} اشیایی مانند Pod را مدیریت می‌کند،  
از برچسب‌ها برای پیگیری تغییرات گروهی از اشیاء مرتبط استفاده می‌کند.  

برای مثال، وقتی یک {{<glossary_tooltip text="Job" term_id="job">}} یک یا چند Pod ایجاد می‌کند،  
کنترلر Job به آن پادها برچسب می‌زند و تغییرات هر Pod در خوشه با همان برچسب را پیگیری می‌کند.

کنترلر Job همچنین *مراجع مالک* را به آن پادها اضافه می‌کند که به Jobی اشاره دارند  
که پادها را ایجاد کرده است.  
اگر Job را زمانی که این پادها در حال اجرا هستند حذف کنید، کوبرنتیز از مراجع مالک (نه برچسب‌ها)  
برای تعیین این که کدام پادها در خوشه نیاز به پاک‌سازی دارند، استفاده می‌کند.

کوبرنتیز همچنین هنگام شناسایی مراجع مالک روی منبع هدف قرار گرفته برای حذف،  
پایان‌دهنده‌ها را پردازش می‌کند.

در برخی مواقع، پایان‌دهنده‌ها می‌توانند از حذف اشیاء وابسته جلوگیری کنند،  
که ممکن است باعث شود شیء مالک هدف برای مدتی طولانی‌تر از حد انتظار بدون حذف کامل باقی بماند.  
در این شرایط باید پایان‌دهنده‌ها و مراجع مالک را روی شیء مالک هدف و اشیاء وابسته بررسی کنید  
تا علت را عیب‌یابی کنید.

{{<note>}}
در مواردی که اشیاء در حالت حذف گیر کرده‌اند، از حذف دستی پایان‌دهنده‌ها خودداری کنید تا فرایند حذف ادامه یابد. پایان‌دهنده‌ها معمولاً به دلایلی به منابع اضافه می‌شوند، پس حذف اجباری آن‌ها می‌تواند به مشکلاتی در خوشه شما منجر شود. این کار تنها زمانی انجام شود که هدف پایان‌دهنده مشخص باشد و به روش دیگری (مثلاً پاک‌سازی دستی یک شیء وابسته) برآورده شده باشد.
{{</note>}}

## {{% heading "whatsnext" %}}

* [استفاده از پایان‌دهنده‌ها برای کنترل حذف](/blog/2021/05/14/using-finalizers-to-control-deletion/) را در بلاگ کوبرنتیز بخوانید.
