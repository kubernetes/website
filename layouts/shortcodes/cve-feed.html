{{ $feed := getJSON .Site.Params.cveFeedBucket }}
{{ if ne $feed.version "https://jsonfeed.org/version/1.1" }}
  {{ warnf "CVE feed shortcode. KEP-3203: CVE feed does not comply with JSON feed v1.1." }}
{{ end }}

<table class="security-cves" data-cve-feed-bucket="{{ .Site.Params.cveFeedBucket }}">
  <caption style="caption-side: top;">{{ T "cve_table" }} {{ printf (T "cve_table_date_format_string") ($feed._kubernetes_io.updated_at | time.Format (T "cve_table_date_format")) }}</caption>
  <thead>
  <tr>
    <th>{{ T "cve_id" }}</th>
    <th>{{ T "cve_summary" }}</th>
    <th>{{ T "cve_issue_url" }}</th>
  </tr>
  </thead>
  <tbody>
  {{ range $feed.items }}
  <tr>
    <td><a href="{{ .url }}">{{ .id | htmlEscape | safeHTML }}</a></td>
    <td>{{ .summary | htmlEscape | safeHTML }}</td>
    <td><a href="{{ .url }}">#{{ ._kubernetes_io.issue_number }}</a></td>
  </tr>
  {{ end }}
  </tbody>
</table>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const table = document.querySelector("table.security-cves")
    const cveFeedBucket = table.getAttribute("data-cve-feed-bucket")
    const tbody = table.querySelector("tbody")
    const cachedInnerHTML = tbody.innerHTML
  
    const renderCVEs = (cves) => {
      let tbodyHTML = ""
      for (let cve of cves) {
        tbodyHTML += `<tr>
          <td><a href="${cve.url}">${cve.id}</a></td>
          <td>${cve.summary}</td>
          <td><a href="${cve.url}">#${cve["_kubernetes_io"].issue_number}</a></td>
        </tr>`
      } 
      return tbodyHTML
    } 

    const fetchCves = () => {
      fetch(cveFeedBucket)
      .then(resp => resp.json())
      .then(content => {
        tbody.innerHTML = renderCVEs(content.items)
      }).catch(() => {
        // If cannot fetch cves, show cached cves
        tbody.innerHTML = cachedInnerHTML
      })
    }

    // run at page load
    fetchCves()

    // run every 10 mins
    setInterval(() => {
      fetchCves()
    }, 10 * 60 * 1000)
  })
</script>
