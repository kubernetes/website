{{/* TOC List Component for Bottom Bar */}}
{{ $navRoot := cond (and (ne .Params.toc_root true) (eq .Site.Home.Type "docs")) .Site.Home .FirstSection -}}
{{ $currentPage := . -}}
{{ $ulNr := 0 -}}
{{ $sidebarMenuTruncate := cond (isset .Site.Params.ui "sidebar_menu_truncate") .Site.Params.ui.sidebar_menu_truncate 50 -}}
{{ $currentLang := string .Site.Language -}}

<div class="bottom-bar-toc">
  <ul class="bottom-bar-toc__list ul-{{ $ulNr }}">
    {{ template "bottom-bar-toc-section" (dict "page" . "section" $navRoot "sidebarMenuTruncate" $sidebarMenuTruncate "ulNr" $ulNr "currentLang" $currentLang) }}
  </ul>
</div>

{{ define "bottom-bar-toc-section" -}}
{{ $s := .section -}}
{{ $p := .page -}}
{{ $sidebarMenuTruncate := .sidebarMenuTruncate -}}
{{ $treeRoot := cond (eq .ulNr 0) true false -}}
{{ $ulNr := .ulNr -}}
{{ $currentLang := .currentLang -}}
{{ $active := eq $s $p -}}
{{ $activePath := or (eq $p $s) ($p.IsDescendant $s) -}}
{{ $mid := printf "toc-%s" ($s.RelPermalink | anchorize) -}}
{{ $pages_tmp := where (union $s.Pages $s.Sections).ByWeight ".Params.toc_hide" "!=" true -}}

{{/* Handle translations */}}
{{ with site.Params.language_alternatives -}}
  {{ range . }}
    {{ with (where $.section.Translations ".Lang" . ) -}}
      {{ $p := index . 0 -}}
      {{ $pages_tmp = where ( $pages_tmp | lang.Merge (union $p.Pages $p.Sections)) ".Params.toc_hide" "!=" true -}}
    {{ end -}}
  {{ end -}}
{{ end -}}

{{ $pages := $pages_tmp | first $sidebarMenuTruncate -}}
{{ $withChild := gt (len $pages) 0 -}}
{{ $manualLink := cond (isset $s.Params "manuallink") $s.Params.manualLink ( cond (isset $s.Params "manuallinkrelref") (relref $s $s.Params.manualLinkRelref) $s.RelPermalink) -}}
{{ $manualLinkTitle := cond (isset $s.Params "manuallinktitle") $s.Params.manualLinkTitle $s.Title -}}
{{ $isForeignLanguage := (ne (string $s.Lang) ($.currentLang)) -}}

<li class="bottom-bar-toc__item{{ if $withChild }} with-child{{ else }} without-child{{ end }}{{ if $activePath }} active-path{{ end }}{{ if $active }} active{{ end }}" id="{{ $mid }}-li" data-level="{{ $ulNr }}">
  <div class="bottom-bar-toc__item-wrapper">
    {{ if $withChild -}}
    <button class="bottom-bar-toc__toggle" aria-expanded="{{ if $activePath }}true{{ else }}false{{ end }}" aria-controls="{{ $mid }}-children">
      <svg width="12" height="12" viewBox="0 0 12 12" class="chevron">
        <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </svg>
    </button>
    {{- end }}
    <a href="{{ $manualLink }}"{{ if ne $s.LinkTitle $manualLinkTitle }} title="{{ $manualLinkTitle }}"{{ end }}{{ with $s.Params.manualLinkTarget }} target="{{ . }}"{{ if eq . "_blank" }} rel="noopener"{{ end }}{{ end }} class="bottom-bar-toc__link{{ if $active }} active{{ end }}{{ if $s.IsPage }} is-page{{ else }} is-section{{ end }}" id="{{ $mid }}">
      {{ with $s.Params.Icon }}<i class="{{ . }}"></i>{{ end }}
      <span>{{ $s.LinkTitle }}</span>
      {{ if $isForeignLanguage }}<small class="lang-indicator">({{ $s.Lang | upper }})</small>{{ end }}
    </a>
  </div>
  {{- if $withChild }}
  {{- $ulNr = add $ulNr 1 }}
  <ul class="bottom-bar-toc__children ul-{{ $ulNr }}{{ if $activePath }} expanded{{ end }}" id="{{ $mid }}-children">
    {{ range $pages -}}
    {{ if (not (and (eq $s $p.Site.Home) (eq .Params.toc_root true))) -}}
    {{ template "bottom-bar-toc-section" (dict "page" $p "section" . "sidebarMenuTruncate" $sidebarMenuTruncate "ulNr" $ulNr "currentLang" $currentLang) }}
    {{- end }}
    {{- end }}
  </ul>
  {{- end }}
</li>
{{- end }}